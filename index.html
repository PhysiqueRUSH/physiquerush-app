<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysiqueRush - Massive Impact</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffeb3b">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{
            --bg-color:#121212;
            --text-color:#ffffff;
            --accent-pink:#ff6ec7;
            --accent-green:#4caf50;
            --accent-yellow:#ffeb3b;
            --accent-red:#f44336;
            --card-bg:#1e1e1e;
            --modal-bg:rgba(0,0,0,0.85);
        }

        body{
            margin:0;
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            color:var(--text-color);
            display:flex;
            flex-direction:column;
            align-items:center;
            min-height:100vh;
            padding-bottom:50px;
            background:transparent;
        }

        #app-background{position:fixed;top:0;left:0;width:100%;height:100%;background-color:var(--bg-color);z-index:-2;}
        #lightning-container{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-1;pointer-events:none;overflow:hidden;}
        .lightning-flash{position:absolute;max-width:none;opacity:.8;pointer-events:none;}

        .container{width:95%;max-width:500px;padding:20px;text-align:center;position:relative;z-index:1;}
        .hidden{display:none!important;}

        /* BUTTONS */
        .btn{display:block;width:100%;padding:15px;margin:10px 0;background:var(--card-bg);color:#fff;border:1px solid #333;cursor:pointer;text-align:center;font-weight:900;text-transform:uppercase;border-radius:10px;transition:.2s;}
        .btn:hover{background:#333;}
        .btn-red{background:var(--accent-red);color:#000;border:none;}
        .btn-outline{background:transparent;border:1px solid var(--accent-red);color:var(--accent-red);}
        .btn-danger-zone{margin-top:30px;border:1px solid var(--accent-red);color:var(--accent-red);opacity:.7;font-size:.8em;}
        .btn-small{padding:10px;font-size:.9em;}
        .btn-validate{background:var(--accent-yellow)!important;color:#000!important;border:none!important;font-weight:1000!important;}

        /* IMAGES */
        .main-img{display:block;margin:0 auto 15px auto;border-radius:15px;}
        .logo-reduced{width:20%;max-width:80px;}
        .glow-effect{width:100%;max-width:100%;animation:redPulse 2s infinite ease-in-out;}
        @keyframes redPulse{
            0%{box-shadow:0 0 5px rgba(244,67,54,.3);}
            50%{box-shadow:0 0 25px rgba(244,67,54,.8),0 0 10px rgba(244,67,54,.6);}
            100%{box-shadow:0 0 5px rgba(244,67,54,.3);}
        }

        /* HEADER */
        #char-display{margin-bottom:20px;margin-top:10px;}
        #char-img{max-width:250px;display:block;margin:0 auto;transition:transform .3s;}
        #global-level-badge{font-size:1.4em;font-weight:1000;margin-top:10px;color:var(--accent-yellow);text-shadow:0 0 5px rgba(0,0,0,.5);}

        /* ELEMENTS */
        .video-box{background:#000;min-height:120px;display:flex;align-items:center;justify-content:center;margin:0 0 16px 0;color:#777;border:1px solid #333;font-size:.85em;width:100%;border-radius:12px;padding:10px;box-sizing:border-box;}
        #radar-container{position:relative;width:100%;height:350px;margin:0 auto 20px auto;background:#000;border-radius:10px;border:1px solid #333;display:flex;align-items:center;justify-content:center;}
        canvas{max-width:100%;max-height:100%;}

        /* TRAINING GRID - bigger cells + lock */
        .week-grid{
            display:grid;
            grid-template-columns:repeat(2, 1fr);
            gap:12px;
            margin:18px 0 12px 0;
            justify-content:center;
        }
        .day-box{
            position:relative;
            aspect-ratio:1/1;
            background:#2b2b2b;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            font-size:1.02em;
            border-radius:14px;
            cursor:pointer;
            transition:all .2s;
            border:1px solid #444;
            opacity:1;
            min-height:148px;
        }
        .day-box:hover{transform:scale(1.02);}
        .day-box.done{background:var(--accent-green);color:#000;border:none;font-weight:1000;}
        .day-box.locked{
            background:#202020;
            opacity:.45;
            cursor:not-allowed;
            filter:grayscale(.2);
        }
        .lock-badge{
            position:absolute;
            top:8px; right:8px;
            width:28px; height:28px;
            opacity:.95;
            pointer-events:none;
        }

        /* TIMER */
        .timer-overlay{background:#000;padding:16px;border-radius:14px;border:1px solid #333;margin-bottom:14px;display:flex;flex-direction:column;align-items:center;gap:6px;}
        .timer-digits{font-size:3.2em;font-weight:1000;font-family:monospace;}
        .timer-digits.warning{color:var(--accent-red);}
        .timer-state{font-size:1.05em;color:var(--accent-pink);min-height:1.5em;font-weight:1000;letter-spacing:.5px;}
        .timer-warning{animation:flashWarning .5s infinite;color:var(--accent-red)!important;}
        @keyframes flashWarning{0%{opacity:1;}50%{opacity:.25;}100%{opacity:1;}}

        input[type="number"]{width:140px;padding:10px;text-align:center;border-radius:12px;border:1px solid #444;font-size:1.1em;background:#111;color:#fff;outline:none;}
        input[type="number"]:focus{border-color:var(--accent-yellow);box-shadow:0 0 10px rgba(255,235,59,.15);}

        /* WORKOUT LAYOUT */
        .workout-wrap{display:flex;flex-direction:column;gap:12px;text-align:left;}
        .card{background:#141414;border:1px solid #333;border-radius:14px;padding:14px;box-sizing:border-box;}
        .card h4{margin:0 0 10px 0;color:var(--accent-yellow);text-transform:uppercase;letter-spacing:1px;font-size:.95em;}
        .subtle{color:#888;font-size:.92em;line-height:1.35;}
        .current-exercise{display:flex;gap:12px;align-items:center;}
        .gif-frame{width:110px;height:110px;border-radius:12px;border:1px solid #333;background:#000;overflow:hidden;flex:0 0 110px;display:flex;align-items:center;justify-content:center;cursor:pointer;}
        .gif-frame img{width:100%;height:100%;object-fit:cover;display:block;}
        .exercise-meta{flex:1;}
        .exercise-name{font-weight:1000;font-size:1.08em;color:#fff;margin-bottom:6px;}
        .exercise-pill{display:inline-block;background:#0d0d0d;border:1px solid #333;border-radius:999px;padding:6px 10px;font-weight:1000;font-size:.85em;color:var(--accent-pink);}
        .exercise-pill.done{color:#000;background:var(--accent-green);border:none;}
        .exercise-pill.current{color:#000;background:var(--accent-yellow);border:none;}

        .exercise-list{display:flex;flex-direction:column;gap:8px;}
        .exercise-row{display:flex;align-items:center;justify-content:space-between;gap:10px;background:#101010;border:1px solid #2a2a2a;border-radius:12px;padding:10px 12px;}
        .exercise-row .left{display:flex;flex-direction:column;gap:4px;}
        .exercise-row .name{font-weight:1000;color:#fff;font-size:.95em;}
        .exercise-row .time{color:#777;font-size:.85em;}
        .exercise-row.current{border-color:rgba(255,235,59,.6);box-shadow:0 0 10px rgba(255,235,59,.1);}
        .exercise-row.done{opacity:.7;}

        .timer-controls{display:flex;gap:10px;flex-wrap:wrap;}
        .timer-controls .btn{margin:0;flex:1 1 30%;}

        .score-area{display:flex;flex-direction:column;gap:10px;}
        .score-inline{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
        .score-inline label{font-weight:1000;color:#fff;}
        .score-help{color:#888;font-size:.9em;margin-top:-4px;}

        /* BEAT THE BOSS ‚Äî resserr√©/cintr√© + centr√© */
        .boss-section{
            border:1px solid #3a3a3a;
            padding:6px 6px 8px 6px;
            border-radius:14px;
            background:#151515;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:3px;
            width:fit-content;
            margin:8px auto;            /* <-- center horizontally */
        }
        .boss-title{margin:0;color:var(--accent-red);font-weight:1000;text-transform:uppercase;font-size:.86em;letter-spacing:1px;line-height:1.05;}
        .boss-sub{margin:0;color:#ddd;font-weight:1000;font-size:.9em;line-height:1.1;}
        .boss-grade{margin:0;color:#aaa;font-weight:900;font-size:.78em;line-height:1.15;text-align:center;max-width:260px;}
        #boss-img-preview{width:225px;height:225px;object-fit:contain;margin:0;}
        #boss-score-target{font-size:1.0em;font-weight:1000;color:#fff;margin:0;line-height:1.05;}

        /* R√âCOMPENSES ‚Äî cards cintr√©es + lock visuel */
        .stats-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
        .stat-card{
            background:#1a1a1a;
            border:1px solid #444;
            border-radius:14px;
            padding:8px 6px 10px 6px;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            height:auto;
            cursor:pointer;
            overflow:hidden;
        }
        .stat-card:active{transform:scale(.98);}
        .stat-icon{width:130px;height:130px;object-fit:contain;margin:0 0 4px 0;}
        .stat-icon.smallish{width:118px;height:118px;}
        .stat-value{font-size:1.7em;font-weight:1000;color:var(--accent-yellow);line-height:1.0;}
        .stat-label{font-size:.85em;color:#888;margin-top:4px;text-transform:uppercase;font-weight:1000;text-align:center;line-height:1.15;}
        .tiny-under{font-size:.68em;color:#777;opacity:.9;margin-top:2px;text-align:center;line-height:1.2;}

        .stat-card.locked .stat-icon{filter:grayscale(1);opacity:.35;}
        .stat-card.locked .stat-value{opacity:.55;}
        .stat-card.locked .stat-label{opacity:.75;}

        .whatsapp-icon{width:24px;vertical-align:middle;margin-left:10px;}

        /* MODAL */
        #custom-modal{
            position:fixed;top:0;left:0;width:100%;height:100%;
            background-color:var(--modal-bg);
            z-index:9999;
            display:flex;align-items:center;justify-content:center;
            backdrop-filter:blur(5px);
        }
        .modal-content{
            background:#1a1a1a;
            border:2px solid #444;
            padding:22px;
            border-radius:16px;
            width:92%;
            max-width:430px;
            text-align:center;
            box-shadow:0 0 20px rgba(0,0,0,.8);
            animation:modalPop .3s ease-out;
        }
        @keyframes modalPop{from{transform:scale(.8);opacity:0;}to{transform:scale(1);opacity:1;}}
        .modal-title{font-size:1.3em;font-weight:1000;margin-bottom:12px;color:var(--accent-yellow);text-transform:uppercase;}
        .modal-msg{font-size:1.05em;margin-bottom:18px;line-height:1.5;}
        .modal-actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
        .modal-btn{padding:10px 18px;border-radius:12px;cursor:pointer;border:none;font-weight:1000;text-transform:uppercase;}
        .btn-modal-confirm{background:var(--accent-green);color:#000;}
        .btn-modal-cancel{background:#333;color:#fff;border:1px solid #555;}

        .video-iframe{width:100%;height:240px;border:0;border-radius:12px;background:#000;margin-top:10px;}

        .test-ex-name{
            font-size:1.25em;font-weight:1000;color:var(--accent-yellow);
            text-transform:uppercase;letter-spacing:1px;margin:8px 0 6px 0;text-align:center;
        }
        .test-do{font-size:1.35em;font-weight:1000;color:#fff;margin:0 0 10px 0;text-align:center;}
        .test-do b{color:var(--accent-yellow);}

        .menu-version{margin-top:8px;font-size:.55em;opacity:.25;text-align:center;letter-spacing:1px;}
    </style>
</head>
<body>

    <div id="app-background"></div>
    <div id="lightning-container"></div>

    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <div id="modal-title" class="modal-title">TITRE</div>
            <div id="modal-msg" class="modal-msg">Message ici</div>
            <div id="modal-actions" class="modal-actions"></div>
        </div>
    </div>

    <!-- MENU -->
    <div id="screen-menu" class="container">
        <img src="physiquerush.png" class="main-img logo-reduced" alt="Logo" onerror="this.style.display='none'">
        <img src="MIAH.png" class="main-img glow-effect" alt="MIAH" onerror="this.style.display='none'">

        <div id="char-display">
            <img id="char-img" src="evo1.png" alt="Perso" onerror="this.src='https://via.placeholder.com/250x300?text=Perso'">
            <div id="global-level-badge">Niveau 0 / 40</div>
        </div>

        <button class="btn" onclick="nav.to('screen-levels')">SALLE DES TESTS</button>
        <button class="btn" onclick="nav.to('screen-training')">ZONE D'ENTRA√éNEMENT</button>
        <button class="btn" onclick="ui.alert('Patience...', 'Le Module Nutri-Rush sera bient√¥t disponible !')">NUTRI-RUSH</button>
        <button class="btn" onclick="nav.to('screen-trophy')">R√âCOMPENSES ET STATS</button>

        <button class="btn" onclick="window.location.href='https://wa.me/'">La Team PhysiqueRush <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" class="whatsapp-icon"></button>
        <button class="btn" onclick="window.close(); window.location.href='about:blank';">QUITTER</button>
        <div class="menu-version">v xyz</div>
    </div>

    <!-- LEVELS -->
    <div id="screen-levels" class="container hidden">
        <h2>SALLE DES TESTS</h2>
        <button class="btn" onclick="evoLab.init()">Evolution Lab</button>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <button class="btn" onclick="tests.start('Pectoraux')">Test Pecs</button>
            <button class="btn" onclick="tests.start('Jambes')">Test Jambes</button>
            <button class="btn" onclick="tests.start('Dos')">Test Dos</button>
            <button class="btn" onclick="tests.start('Triceps')">Test Triceps</button>
            <button class="btn" onclick="tests.start('Biceps')">Test Biceps</button>
        </div>
        <button class="btn" onclick="nav.to('screen-menu')" style="margin-top:20px;">Retour</button>
    </div>

    <!-- EVOLAB -->
    <div id="screen-evolab" class="container hidden">
        <h3>Evolution Lab</h3>
        <div id="radar-container"><canvas id="radarChart"></canvas></div>
        <div id="evolab-global" style="font-size:1.2em;color:var(--accent-yellow);font-weight:1000;margin-bottom:15px;"></div>
        <button class="btn" onclick="nav.to('screen-levels')">Retour</button>
        <button class="btn btn-danger-zone" onclick="evoLab.resetTests()">‚ö†Ô∏è R√âINITIALISER MES TESTS</button>
    </div>

    <!-- TEST -->
    <div id="screen-test" class="container hidden">
        <h2 id="test-name">Test</h2>

        <div class="video-box">[VIDEO VIMEO PLACEHOLDER ‚Äî pr√©sentation du test]</div>

        <div id="test-principle" class="subtle" style="text-align:left;margin:0 0 12px 0;">‚Äî</div>

        <div class="card" style="margin-bottom:12px;text-align:left;">
            <h4>Exercice du test</h4>
            <div class="current-exercise">
                <div class="gif-frame" onclick="tests.openExerciseVideo()" title="Clique pour ouvrir la vid√©o">
                    <img id="test-gif" src="https://via.placeholder.com/220x220?text=GIF" alt="GIF exercice test">
                </div>
                <div class="exercise-meta">
                    <div id="test-exercise-highlight" class="exercise-name">‚Äî</div>
                    <div class="subtle">Cliquez sur le GIF pour voir la vid√©o de l‚Äôexercice.</div>
                </div>
            </div>
        </div>

        <div class="timer-overlay" id="test-timer-panel">
            <div id="test-instruction-state" class="timer-state">Pr√™t ?</div>
            <div id="timer-display" class="timer-digits">08:00</div>
            <div id="current-palier" style="margin-top:2px;font-size:1.15em;color:#aaa;font-weight:1000;">Palier 1</div>

            <div id="reps-target" class="test-do">Fa√Ætes <b>10</b> r√©p√©titions</div>

            <div id="palier-status" class="subtle" style="text-align:center;max-width:420px;">
                Cliquez <b>VALIDER</b> d√®s que vous avez r√©alis√© l'objectif du palier.
            </div>
        </div>

        <div id="test-exercise-name" class="test-ex-name">‚Äî</div>

        <button id="btn-start-test" class="btn btn-red" onclick="tests.run()">LANCER LE TEST</button>
        <button id="btn-validate-palier" class="btn hidden" onclick="tests.validatePalier()" style="background:var(--accent-yellow);color:#000;border:none;">
            ‚úÖ VALIDER (objectif atteint)
        </button>
        <button id="btn-fail-test" class="btn hidden" onclick="tests.fail()" style="background:#222;border:1px solid var(--accent-red);color:var(--accent-red);">
            J'AI √âCHOU√â / FIN
        </button>
        <button id="btn-test-retour" class="btn" onclick="tests.quit()">Retour</button>
    </div>

    <!-- TRAINING -->
    <div id="screen-training" class="container hidden">
        <h2 style="font-size:2em;text-transform:uppercase;letter-spacing:2px;margin-bottom:10px;">ZONE D'ENTRA√éNEMENT</h2>
        <div class="subtle" style="text-align:center;margin-bottom:10px;">
            Seul le <b>prochain jour</b> √† valider est disponible.
        </div>

        <div class="week-grid" id="week-grid"></div>

        <button class="btn btn-danger-zone" onclick="training.resetAllTrainings()">‚ö†Ô∏è R√âINITIALISER TOUS LES ENTRA√éNEMENTS</button>
        <button class="btn" onclick="nav.to('screen-menu')" id="btn-training-retour" style="margin-top:10px;">Retour</button>
    </div>

    <!-- WORKOUT -->
    <div id="screen-workout" class="container hidden">
        <h2 id="workout-day-title">Jx</h2>

        <div class="workout-wrap">
            <div class="card" style="text-align:center;">
                <h4>Vid√©o de pr√©sentation</h4>
                <div class="video-box" style="margin:0;">
                    <div>
                        [VIMEO PLACEHOLDER]<br>
                        <button class="btn btn-small" style="max-width:260px;margin:12px auto 0 auto;" onclick="training.openWorkoutIntroVideo()">‚ñ∂Ô∏è Ouvrir la vid√©o</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h4>Exercice en cours</h4>
                <div class="current-exercise">
                    <div class="gif-frame" onclick="training.openCurrentExerciseVideo()" title="Clique pour ouvrir la vid√©o">
                        <img id="exercise-gif" src="https://via.placeholder.com/220x220?text=GIF" alt="GIF exercice">
                    </div>
                    <div class="exercise-meta">
                        <div id="exercise-name-current" class="exercise-name">‚Äî</div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;">
                            <span id="exercise-pill-current" class="exercise-pill current">ACTUEL</span>
                            <span id="exercise-duration" class="exercise-pill">‚è±Ô∏è 02:00</span>
                        </div>
                        <div id="exercise-hint" class="subtle" style="margin-top:8px;">√Ä la fin, on passe √† l'exercice suivant.</div>
                    </div>
                </div>
            </div>

            <div class="timer-overlay" id="workout-chrono-panel">
                <div id="workout-timer-state" class="timer-state">Pr√™t</div>
                <div id="workout-timer-digits" class="timer-digits">00:00</div>
                <div class="timer-controls" style="width:100%;margin-top:8px;">
                    <button id="btn-timer-start" class="btn btn-small" onclick="training.timerStartOrResume()">‚ñ∂Ô∏è D√©marrer</button>
                    <button id="btn-timer-pause" class="btn btn-small" onclick="training.timerPause()">‚è∏Ô∏è Pause</button>
                    <button id="btn-timer-reset" class="btn btn-small" onclick="training.timerResetCurrent()">üîÑ R√©initialiser</button>
                </div>
            </div>

            <div class="card">
                <h4>Liste des exercices</h4>
                <div id="workout-exercise-list" class="exercise-list"></div>
            </div>

            <div class="boss-section" aria-label="Beat the Boss">
                <div class="boss-title">BEAT THE BOSS</div>
                <div id="boss-level-line" class="boss-sub">‚Äî</div>
                <img id="boss-img-preview" src="" onerror="this.src='https://via.placeholder.com/225?text=BTB'">
                <div id="boss-score-target">Score √† battre: ???</div>
                <div id="boss-grade-line" class="boss-grade">‚Äî</div>
            </div>

            <div class="card score-area">
                <h4>Score de la s√©ance</h4>
                <div class="score-inline">
                    <label for="workout-score">Total de r√©p√©titions</label>
                    <input type="number" id="workout-score" placeholder="Ex: 132">
                </div>
                <div class="score-help">Entrez ici le <b>nombre total de r√©p√©titions</b> r√©alis√©es sur toute la s√©ance (tous les exercices cumul√©s).</div>
                <button class="btn btn-red" onclick="training.validateSession()">VALIDER LA S√âANCE</button>
                <button id="btn-cancel-session" class="btn hidden" style="background:#222;color:#f44336;border:1px solid #f44336;" onclick="training.cancelSession()">ANNULER / INVALIDER</button>
            </div>

            <button id="btn-workout-retour" class="btn" onclick="training.quit()">Retour</button>
        </div>
    </div>

    <!-- J8 ASCENSION -->
    <div id="screen-ascension" class="container hidden">
        <h2 id="asc-title">Jx ‚Äî Ascension Challenge</h2>

        <div class="card" style="text-align:center;margin-bottom:12px;">
            <h4>Pr√©sentation</h4>
            <div class="video-box" style="margin:0;">
                <div>
                    [VIMEO PLACEHOLDER ‚Äî pr√©sentation challenge]<br>
                    <button class="btn btn-small" style="max-width:260px;margin:12px auto 0 auto;" onclick="ascension.openIntroVideo()">‚ñ∂Ô∏è Ouvrir la vid√©o</button>
                </div>
            </div>
            <div class="subtle" style="margin-top:10px;text-align:left;">
                En 8 minutes : faites le nombre de r√©p√©titions demand√© sur <b>l‚Äôexercice affich√©</b>, puis appuyez sur <b>VALIDER</b> pour passer au suivant.
                Quand tous les exercices du palier sont faits, le palier augmente (+2 r√©p√©titions).
            </div>
        </div>

        <div style="display:flex;gap:12px;align-items:stretch;margin-bottom:12px;">
            <div class="card" style="flex:1;">
                <h4>Temps restant</h4>
                <div class="timer-overlay" style="margin:0;">
                    <div id="asc-timer-state" class="timer-state">Pr√™t</div>
                    <div id="asc-timer-digits" class="timer-digits">08:00</div>
                    <div class="timer-controls" style="width:100%;margin-top:8px;">
                        <button id="btn-asc-start" class="btn btn-small" onclick="ascension.start()">‚ñ∂Ô∏è D√©marrer</button>
                        <button id="btn-asc-pause" class="btn btn-small" onclick="ascension.pause()">‚è∏Ô∏è Pause</button>
                        <button id="btn-asc-reset" class="btn btn-small" onclick="ascension.reset()">üîÑ Reset</button>
                    </div>
                </div>
            </div>

            <div class="card" style="flex:1;display:flex;flex-direction:column;justify-content:center;">
                <h4>Palier</h4>
                <p style="font-size:1.8em;font-weight:1000;color:var(--accent-yellow);text-align:center;margin:0;line-height:1.1;" id="asc-palier-title">Palier 10 r√©p√©titions</p>
                <p style="font-size:1.35em;font-weight:1000;color:#fff;text-align:center;margin:8px 0 0 0;" id="asc-do-now">
                    Fa√Ætes <b style="color:var(--accent-yellow);">10</b> r√©p√©titions
                </p>
            </div>
        </div>

        <div class="card" id="asc-current-card" style="margin-bottom:12px;">
            <h4>Exercice √† faire maintenant</h4>
            <div class="current-exercise">
                <div class="gif-frame" onclick="ascension.openCurrentVideo()" title="Clique pour ouvrir la vid√©o">
                    <img id="asc-gif" src="https://via.placeholder.com/220x220?text=GIF" alt="GIF exercice">
                </div>
                <div class="exercise-meta">
                    <div id="asc-exercise-name" class="exercise-name">‚Äî</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <span class="exercise-pill current" id="asc-step-pill">EX 1/5</span>
                        <span class="exercise-pill" id="asc-progress-pill">Paliers: 0 ‚Ä¢ Ex: 0</span>
                    </div>
                    <div class="subtle" style="margin-top:8px;">
                        Objectif imm√©diat : <b><span id="asc-target-inline">10</span> r√©p√©titions</b> sur l‚Äôexercice affich√©, puis <b>VALIDER</b>.
                    </div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom:12px;">
            <h4>Ordre des exercices</h4>
            <div id="asc-exercise-list" class="exercise-list"></div>
        </div>

        <div style="position:sticky;bottom:12px;z-index:3;margin-top:6px;">
            <button id="btn-asc-validate" class="btn btn-validate" onclick="ascension.validate()">‚úÖ VALIDER (r√©p√©titions faites)</button>
        </div>

        <div class="card score-area" style="margin-top:8px;">
            <h4>Score du challenge</h4>
            <div class="subtle" style="margin-top:-4px;">
                Le score est calcul√© automatiquement √† la fin. Vous pouvez aussi enregistrer / invalider ensuite.
            </div>
            <button id="btn-asc-cancel" class="btn hidden" style="background:#222;color:#f44336;border:1px solid #f44336;" onclick="ascension.cancel()">ANNULER / INVALIDER</button>
        </div>

        <button class="btn" onclick="ascension.quit()">Retour</button>
    </div>

    <!-- TROPHIES -->
    <div id="screen-trophy" class="container hidden">
        <h2>R√âCOMPENSES ET STATS</h2>

        <div style="margin-bottom:14px;padding:8px;">
            <img id="trophy-char-img" src="" style="width:190px;margin:0 auto;display:block;">
            <div id="trophy-next-evo" style="color:#aaa;font-size:.9em;margin-top:8px;font-style:italic;"></div>
        </div>

        <h3 style="border-bottom:1px solid #333;padding-bottom:5px;margin-bottom:12px;">Performances</h3>
        <div class="stats-row">
            <div id="card-records" class="stat-card" onclick="gallery.explain('records')">
                <img src="record.png" class="stat-icon" onerror="this.src='https://via.placeholder.com/130?text=Rec'">
                <span id="total-records" class="stat-value">0</span>
                <span class="stat-label">Records Battus</span>
            </div>

            <div id="card-fury" class="stat-card" onclick="gallery.explain('fury')">
                <img src="fury.png" class="stat-icon" onerror="this.src='https://via.placeholder.com/130?text=Fury'">
                <span id="fury-count-display" class="stat-value">0</span>
                <span class="stat-label">Furie</span>
            </div>

            <div id="card-unstoppable" class="stat-card" onclick="gallery.explain('unstoppable')">
                <img src="unstoppable.png" class="stat-icon smallish" onerror="this.src='https://via.placeholder.com/130?text=GO'">
                <span id="unstoppable-display" class="stat-value">0</span>
                <span class="stat-label">Unstoppable</span>
                <div id="unstoppable-remaining" class="tiny-under">(encore 21 jours)</div>
            </div>
        </div>

        <h3 style="border-bottom:1px solid #333;padding-bottom:5px;margin-bottom:12px;">Boss Vaincus</h3>
        <div id="boss-trophy-container" class="stats-row"></div>

        <h3 style="border-bottom:1px solid #333;padding-bottom:5px;margin-bottom:12px;">Statistiques</h3>
        <div class="stats-row" id="stats-empty"></div>

        <button class="btn" style="margin-top:14px;" onclick="nav.to('screen-menu')">Retour</button>
        <button class="btn btn-danger-zone" onclick="gallery.resetTrophies()">‚ö†Ô∏è EFFACER TOUTES LES R√âCOMPENSES</button>
    </div>

    <script>
        // --- UI ---
        const ui = {
            modal: document.getElementById('custom-modal'),
            title: document.getElementById('modal-title'),
            msg: document.getElementById('modal-msg'),
            actions: document.getElementById('modal-actions'),
            show: (title, message, buttons = []) => {
                ui.title.innerText = title;
                ui.msg.innerHTML = message;
                ui.actions.innerHTML = '';
                buttons.forEach(btn => {
                    const b = document.createElement('button');
                    b.className = 'modal-btn ' + (btn.class || '');
                    b.innerText = btn.text;
                    b.onclick = () => { ui.hide(); if(btn.onClick) btn.onClick(); };
                    ui.actions.appendChild(b);
                });
                ui.modal.classList.remove('hidden');
            },
            hide: () => ui.modal.classList.add('hidden'),
            alert: (title, message, callback) =>
                ui.show(title, message, [{ text: 'OK', class: 'btn-modal-confirm', onClick: callback }]),
            confirm: (title, message, onConfirm) =>
                ui.show(title, message, [
                    { text: 'Annuler', class: 'btn-modal-cancel' },
                    { text: 'Confirmer', class: 'btn-modal-confirm', onClick: onConfirm }
                ]),
            showResult: (score, callback) => {
                let rank = "D√âBUTANT";
                let color = "#ff6ec7";
                if(score >= 3) { rank = "INTERM√âDIAIRE"; color = "#4caf50"; }
                if(score >= 5) { rank = "AVANC√â"; color = "#ffeb3b"; }
                if(score >= 7) { rank = "EXPERT"; color = "#f44336"; }
                const html = `
                    <div style="font-size:3em;font-weight:1000;margin-bottom:10px;">${score}</div>
                    <div style="font-size:1.35em;font-weight:1000;color:${color};border:2px solid ${color};padding:10px;border-radius:12px;display:inline-block;">${rank}</div>
                    <div style="margin-top:15px;font-style:italic;">Dernier palier valid√©</div>
                `;
                ui.show("R√âSULTAT DU TEST", html, [{ text: 'CONTINUER', class: 'btn-modal-confirm', onClick: callback }]);
            },
            video: (title, vimeoUrl) => {
                const safeUrl = vimeoUrl || "https://player.vimeo.com/video/000000000";
                const html = `
                    <div class="subtle" style="text-align:left;">Vid√©o (placeholder). Remplacez l'URL Vimeo dans le code.</div>
                    <iframe class="video-iframe" src="${safeUrl}" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>
                `;
                ui.show(title, html, [{ text: "FERMER", class: "btn-modal-cancel" }]);
            }
        };

        // --- AUDIO ---
        const audio = {
            ctx: null,
            init: () => { if(!audio.ctx) audio.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            beep: (type) => {
                audio.init();
                if(type === 'end') {
                    const t = audio.ctx.currentTime;
                    const seq = [
                        {f: 900, d: 0.12, g: 0.22},
                        {f: 700, d: 0.12, g: 0.22},
                        {f: 1000, d: 0.20, g: 0.28},
                        {f: 1200, d: 0.25, g: 0.30},
                    ];
                    seq.forEach((s, i) => {
                        const o = audio.ctx.createOscillator();
                        const ga = audio.ctx.createGain();
                        o.connect(ga); ga.connect(audio.ctx.destination);
                        o.type = 'sine';
                        o.frequency.setValueAtTime(s.f, t + i*0.18);
                        ga.gain.setValueAtTime(s.g, t + i*0.18);
                        o.start(t + i*0.18);
                        o.stop(t + i*0.18 + s.d);
                    });
                    return;
                }
                const osc = audio.ctx.createOscillator();
                const gain = audio.ctx.createGain();
                osc.connect(gain);
                gain.connect(audio.ctx.destination);
                osc.type = 'sine';
                if(type === 'long') {
                    osc.frequency.setValueAtTime(600, audio.ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(300, audio.ctx.currentTime + 0.5);
                    gain.gain.setValueAtTime(0.5, audio.ctx.currentTime);
                    osc.start();
                    osc.stop(audio.ctx.currentTime + 0.6);
                } else {
                    osc.frequency.value = 880;
                    gain.gain.setValueAtTime(0.12, audio.ctx.currentTime);
                    osc.start();
                    osc.stop(audio.ctx.currentTime + 0.1);
                }
            }
        };

        // --- ASSETS ---
        const assets = {
            slugify: (s) => (s || "")
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-z0-9]+/g, "-")
                .replace(/(^-|-$)/g, ""),
            gifFor: (exerciseName) => `gifs/${assets.slugify(exerciseName)}.gif`,
            vimeoFor: (exerciseName) => `https://player.vimeo.com/video/000000000`
        };

        // --- DATE UTILS ---
        const dateUtil = {
            localISO: (d = new Date()) => {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2,'0');
                const day = String(d.getDate()).padStart(2,'0');
                return `${y}-${m}-${day}`;
            },
            parseLocal: (iso) => {
                const [y,m,d] = (iso||"").split("-").map(Number);
                return new Date(y, (m||1)-1, d||1);
            },
            addDays: (iso, delta) => {
                const dt = dateUtil.parseLocal(iso);
                dt.setDate(dt.getDate() + delta);
                return dateUtil.localISO(dt);
            }
        };

        // --- BACKGROUND FX ---
        const lightning = {
            container: document.getElementById('lightning-container'),
            images: ['eclair1.png','eclair2.png','eclair3.png'],
            init: () => lightning.schedule(),
            schedule: () => {
                const delay = Math.random() * (5000 - 300) + 300;
                setTimeout(() => { lightning.flash(); lightning.schedule(); }, delay);
            },
            flash: () => {
                const imgName = lightning.images[Math.floor(Math.random()*lightning.images.length)];
                const img = document.createElement('img');
                img.src = imgName;
                img.className = 'lightning-flash';
                if(imgName === 'eclair1.png') {
                    img.style.left = '0px';
                    img.style.top = (Math.random()*80) + '%';
                } else {
                    img.style.top = '0px';
                    img.style.left = (Math.random()*80) + '%';
                }
                lightning.container.appendChild(img);
                setTimeout(() => img.remove(), 150);
            }
        };

        // --- BOSS SYSTEM (tiers + grades) ---
        const BOSS_TIERS = [
            { id: 1, name: "D√©butant", img: "btb1.png" },
            { id: 2, name: "Interm√©diaire", img: "btb2.png" },
            { id: 3, name: "Avanc√©", img: "btb3.png" },
            { id: 4, name: "Expert", img: "btb4.png" }
        ];

        const BOSS_GRADES = [
            "Biomasse Inerte",
            "Larve Incubatrice",
            "Micro-Drone de Surveillance",
            "Symbiote Mineur",
            "√âclaireur Synaptique",
            "Fantassin de Ruche",
            "Maraudeur d'√âlite",
            "Centurion Bio-M√©canique",
            "Technomancien Orbital",
            "Superviseur de Couv√©e",
            "Primus Tacticien",
            "Inquisiteur Neural",
            "Archonte Psionique",
            "Ex√©cuteur Plan√©taire",
            "Seigneur de Guerre Galactique",
            "Ma√Ætre-Esprit",
            "Omniscient Cosmique"
        ];

        const boss = {
            key: (slot, tier) => `slot${slot}_tier${tier}`,
            ensure: (slot, tier) => {
                if(!data.bossMeta) data.bossMeta = {};
                if(!data.bossDefeated) data.bossDefeated = {};
                const k = boss.key(slot, tier);
                if(!data.bossMeta[k]) data.bossMeta[k] = { target: 100, gradeIndex: 0 };
                if(!data.bossDefeated[k]) data.bossDefeated[k] = {}; // gradeIndex -> count
                // clamp
                data.bossMeta[k].gradeIndex = Math.max(0, Math.min(BOSS_GRADES.length-1, data.bossMeta[k].gradeIndex|0));
                data.bossMeta[k].target = Math.max(1, data.bossMeta[k].target|0);
                return data.bossMeta[k];
            },
            getState: (slot, tier) => {
                const st = boss.ensure(slot, tier);
                return {
                    target: st.target|0,
                    gradeIndex: st.gradeIndex|0,
                    gradeName: BOSS_GRADES[st.gradeIndex|0] || BOSS_GRADES[0],
                    isMax: (st.gradeIndex|0) >= (BOSS_GRADES.length-1)
                };
            },
            beat: (slot, tier) => {
                const k = boss.key(slot, tier);
                const st = boss.ensure(slot, tier);
                const g = st.gradeIndex|0;

                // record defeated grade (the one that existed at the moment of the victory)
                if(!data.bossDefeated[k][g]) data.bossDefeated[k][g] = 0;
                data.bossDefeated[k][g]++;

                // if max grade reached: no more changes (grade/target frozen)
                if(g >= BOSS_GRADES.length-1) return;

                // upgrade grade
                st.gradeIndex = g + 1;

                // upgrade target ~ +5% (integer)
                const newTarget = Math.round(st.target * 1.05);
                st.target = Math.max(st.target + 1, newTarget);
            },
            // Sum defeated counts per tier+grade across all slots (1..7) for gallery
            sumDefeated: (tier, gradeIndex) => {
                let sum = 0;
                for(let slot=1; slot<=7; slot++){
                    const k = boss.key(slot, tier);
                    const obj = (data.bossDefeated && data.bossDefeated[k]) ? data.bossDefeated[k] : null;
                    if(obj && obj[gradeIndex]) sum += obj[gradeIndex];
                }
                return sum;
            }
        };

        // --- DB ---
        const db = {
            load: () => JSON.parse(localStorage.getItem('physiqueRushDB')) || db.default(),
            save: (data) => localStorage.setItem('physiqueRushDB', JSON.stringify(data)),
            default: () => ({
                stats: { Pectoraux:0, Jambes:0, Dos:0, Triceps:0, Biceps:0 },
                history: { originalStats: { Pectoraux:0, Jambes:0, Dos:0, Triceps:0, Biceps:0 } },

                // sessions are now keyed by "J<number>" (ex: "J1", "J8", "J9"...)
                sessions: {},
                records: {},

                // boss system
                bossMeta: {},       // slot+tier -> {target, gradeIndex}
                bossDefeated: {},   // slot+tier -> {gradeIndex: count}

                furyCount: 0,
                furyWeek: { slotsBeaten: {} },

                completedDates: {},

                unstoppableEarned: false
            })
        };
        let data = db.load();

        const normalizeData = () => {
            if(!data.sessions) data.sessions = {};
            if(!data.records) data.records = {};

            if(!data.bossMeta) data.bossMeta = {};
            if(!data.bossDefeated) data.bossDefeated = {};

            if(!data.furyWeek) data.furyWeek = { slotsBeaten: {} };
            if(!data.furyWeek.slotsBeaten) data.furyWeek.slotsBeaten = {};

            if(!data.completedDates) data.completedDates = {};
            if(typeof data.unstoppableEarned !== "boolean") data.unstoppableEarned = false;
        };
        normalizeData();

        const streak = {
            currentStreakDays: () => {
                normalizeData();
                const today = dateUtil.localISO();
                let count = 0;
                let cursor = today;
                while(data.completedDates[cursor] && data.completedDates[cursor] > 0) {
                    count++;
                    cursor = dateUtil.addDays(cursor, -1);
                }
                return count;
            },
            remainingToUnstoppable: () => {
                if(data.unstoppableEarned) return 0;
                const s = streak.currentStreakDays();
                return Math.max(0, 21 - s);
            }
        };

        const app = {
            getGlobalLevel: () => Object.values(data.stats).reduce((a,b)=>a+b,0),
            getFunctionalLevel: (muscle) => (data.stats[muscle] || 0) === 0 ? 1 : data.stats[muscle],
            getCharImage: (level) => {
                if(level < 5) return 'evo1.png';
                if(level <= 10) return 'evo1.png';
                if(level <= 15) return 'evo2.png';
                if(level <= 19) return 'evo3.png';
                if(level <= 23) return 'evo4.png';
                if(level <= 26) return 'evo5.png';
                if(level <= 29) return 'evo6.png';
                if(level <= 32) return 'evo7.png';
                if(level <= 34) return 'evo8.png';
                if(level <= 36) return 'evo9.png';
                if(level <= 38) return 'evo10.png';
                if(level === 39) return 'evo11.png';
                return 'evo12.png';
            },
            updateCharacter: () => {
                const lvl = app.getGlobalLevel();
                document.getElementById('char-img').src = app.getCharImage(lvl);
                document.getElementById('global-level-badge').innerText = "Niveau " + lvl + " / 40";
            },
            getLevelColor: (val) => (val<=2?'#ff6ec7':(val<=4?'#4caf50':(val<=6?'#ffeb3b':'#f44336')))
        };

        // --- TESTS ---
        const tests = {
            currentTest: null,
            interval: null,
            config: {
                'Pectoraux': 'Pompes Dead-Stop',
                'Jambes': 'Fentes Saut√©es',
                'Dos': 'Rowing Corner Coudes √âcart√©s',
                'Triceps': 'Dips Chaise Jambes Tendues',
                'Biceps': 'Drag Curl au Sol'
            },
            totalSeconds: 0,
            secondsInMinute: 0,
            palier: 1,
            reps: 10,
            palierValidated: false,
            lastValidatedPalier: 0,

            start: (muscle) => {
                tests.currentTest = muscle;
                clearInterval(tests.interval);
                tests.interval = null;

                const exName = tests.config[muscle];

                document.getElementById('test-name').innerText = "Test " + muscle;
                document.getElementById('test-exercise-name').innerText = exName;
                document.getElementById('test-exercise-highlight').innerText = exName;

                document.getElementById('timer-display').innerText = "08:00";
                document.getElementById('timer-display').classList.remove('warning');

                document.getElementById('test-instruction-state').innerText = "Pr√™t ?";
                document.getElementById('test-instruction-state').classList.remove('timer-warning');

                document.getElementById('current-palier').innerText = "Palier 1";
                document.getElementById('reps-target').innerHTML = `Fa√Ætes <b>10</b> r√©p√©titions`;

                document.getElementById('palier-status').innerHTML = `Cliquez <b>VALIDER</b> d√®s que vous avez r√©alis√© l'objectif du palier.`;

                document.getElementById('test-principle').innerHTML =
                    `Principe : pendant 8 minutes, vous devez valider chaque palier.<br>
                     Exercice : <b>${exName}</b>. D√®s que vous atteignez le nombre de r√©p√©titions du palier, appuyez sur <b>VALIDER</b>.
                     Si la minute se termine sans validation, le test s‚Äôarr√™te et vous gardez le dernier palier valid√©.`;

                document.getElementById('test-gif').src = assets.gifFor(exName);

                document.getElementById('btn-start-test').classList.remove('hidden');
                document.getElementById('btn-validate-palier').classList.add('hidden');
                document.getElementById('btn-fail-test').classList.add('hidden');

                nav.to('screen-test');
                window.scrollTo({ top: 0, behavior: 'auto' });
            },

            openExerciseVideo: () => {
                const exName = tests.config[tests.currentTest] || "Exercice";
                ui.video("VID√âO ‚Äî " + exName, assets.vimeoFor(exName));
            },

            run: () => {
                audio.init();
                clearInterval(tests.interval);

                tests.totalSeconds = 8 * 60;
                tests.secondsInMinute = 60;
                tests.palier = 1;
                tests.reps = 10;
                tests.palierValidated = false;
                tests.lastValidatedPalier = 0;

                document.getElementById('btn-start-test').classList.add('hidden');
                document.getElementById('btn-validate-palier').classList.remove('hidden');
                document.getElementById('btn-fail-test').classList.remove('hidden');

                audio.beep('long');

                const stateDiv = document.getElementById('test-instruction-state');
                const digitsEl = document.getElementById('timer-display');

                const fmt = (sec) => {
                    const m = Math.floor(sec / 60);
                    const s = sec % 60;
                    return `0${m}:${s < 10 ? '0'+s : s}`;
                };

                const nextPalierHint = () => {
                    const totalNext = Math.max(0, tests.totalSeconds - tests.secondsInMinute);
                    const nextMin = Math.floor(totalNext / 60);
                    const nextReps = tests.reps + 2;
                    return `Lorsque le compte √† rebours affichera <b>0${nextMin}:00</b> vous devrez faire <b>${nextReps}</b> r√©p√©titions.`;
                };

                const updateUI = () => {
                    digitsEl.innerText = fmt(tests.totalSeconds);
                    document.getElementById('current-palier').innerText = "Palier " + tests.palier;
                    document.getElementById('reps-target').innerHTML = `Fa√Ætes <b>${tests.reps}</b> r√©p√©titions`;

                    const status = document.getElementById('palier-status');
                    if(tests.palierValidated) {
                        status.innerHTML =
                            `<div><span style="color: var(--accent-green); font-weight:1000;">‚úÖ Palier valid√©</span> ‚Äî vous pouvez r√©cup√©rer jusqu'√† la fin de la minute.</div>
                             <div style="margin-top:6px;">${nextPalierHint()}</div>`;
                    } else {
                        status.innerHTML = `D√®s que vous atteignez <b>${tests.reps}</b> r√©p√©titions, appuyez sur <b>VALIDER</b> avant la fin de la minute.`;
                    }
                };

                updateUI();

                setTimeout(() => {
                    const btnRetour = document.getElementById('btn-test-retour');
                    if(btnRetour) btnRetour.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }, 250);

                tests.interval = setInterval(() => {
                    tests.totalSeconds--;
                    tests.secondsInMinute--;

                    if(tests.secondsInMinute <= 10 && tests.secondsInMinute > 0) {
                        stateDiv.innerText = "PR√âPAREZ-VOUS !";
                        stateDiv.classList.add('timer-warning');
                        digitsEl.classList.add('warning');
                        audio.beep('short');
                    } else {
                        digitsEl.classList.remove('warning');
                        stateDiv.classList.remove('timer-warning');
                        stateDiv.innerText = tests.palierValidated ? "Valid√© ‚úÖ" : "En cours...";
                    }

                    updateUI();

                    if (tests.secondsInMinute <= 0) {
                        if (tests.totalSeconds <= 0) {
                            const finalScore = tests.palierValidated ? tests.palier : tests.lastValidatedPalier;
                            tests.finish(finalScore);
                            return;
                        }

                        if(!tests.palierValidated) {
                            tests.finish(tests.lastValidatedPalier);
                            return;
                        }

                        audio.beep('long');
                        tests.lastValidatedPalier = tests.palier;
                        tests.palier++;
                        tests.reps += 2;
                        tests.secondsInMinute = 60;
                        tests.palierValidated = false;

                        stateDiv.classList.remove('timer-warning');
                        digitsEl.classList.remove('warning');
                        stateDiv.innerText = "GO !";
                        updateUI();
                    }
                }, 1000);
            },

            validatePalier: () => {
                if(!tests.interval) return;
                if(tests.palierValidated) return;
                tests.palierValidated = true;
                tests.lastValidatedPalier = tests.palier;
                audio.beep('long');
            },

            fail: () => tests.finish(tests.lastValidatedPalier),

            finish: (score) => {
                clearInterval(tests.interval);
                tests.interval = null;

                score = Math.max(0, Math.min(8, score|0));
                data.stats[tests.currentTest] = score;
                db.save(data);

                document.getElementById('btn-validate-palier').classList.add('hidden');
                document.getElementById('btn-fail-test').classList.add('hidden');
                document.getElementById('timer-display').classList.remove('warning');

                ui.showResult(score, () => nav.to('screen-levels'));
            },

            quit: () => {
                clearInterval(tests.interval);
                tests.interval = null;
                document.getElementById('timer-display').classList.remove('warning');
                nav.to('screen-levels');
            }
        };

        // --- EVOLUTION LAB ---
        const evoLab = {
            chart: null,
            init: () => {
                nav.to('screen-evolab');
                evoLab.render(data.stats);
                document.getElementById('evolab-global').innerText = "Niveau Global: " + app.getGlobalLevel() + " / 40";
            },
            render: (statsObj) => {
                const ctx = document.getElementById('radarChart').getContext('2d');
                const values = [statsObj.Pectoraux, statsObj.Jambes, statsObj.Dos, statsObj.Triceps, statsObj.Biceps];
                const displayValues = values.map(v => v === 0 ? 1 : v);
                const pointColors = displayValues.map(v => app.getLevelColor(v));

                if(evoLab.chart) evoLab.chart.destroy();
                evoLab.chart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['Pectoraux','Jambes','Dos','Triceps','Biceps'],
                        datasets: [{
                            data: displayValues,
                            backgroundColor: 'rgba(255,235,59,0.2)',
                            borderColor: '#fff',
                            borderWidth: 1,
                            pointBackgroundColor: pointColors,
                            pointBorderColor: '#fff',
                            pointRadius: 6
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                min: 0, max: 8,
                                ticks: { stepSize: 1, display: false },
                                grid: { color: '#444' },
                                pointLabels: { color: '#fff', font: { size: 11, weight:'bold' } },
                                angleLines: { color: '#444' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            },
            resetTests: () => {
                ui.confirm("R√âINITIALISATION", "Voulez-vous vraiment effacer tous vos r√©sultats de tests ? Votre niveau global reviendra √† 0.", () => {
                    data.stats = { Pectoraux:0, Jambes:0, Dos:0, Triceps:0, Biceps:0 };
                    db.save(data);
                    evoLab.init();
                    app.updateCharacter();
                    ui.alert("TERMINE", "Donn√©es r√©initialis√©es.");
                });
            }
        };

        // --- TRAINING (infinite J numbers) ---
        const training = {
            timerInterval: null,
            timerRunning: false,
            timerPaused: false,
            hasAutoScrolledOnFirstStart: false,

            // cycle slots 1..8 (8 = challenge)
            slotLabels: [
                { slot:1, name:'Pectoraux' },
                { slot:2, name:'Jambes (Poly)' },
                { slot:3, name:'Dos' },
                { slot:4, name:'Tri/Bi' },
                { slot:5, name:'Pectoraux' },
                { slot:6, name:'Jambes (Iso)' },
                { slot:7, name:'Dos' },
                { slot:8, name:'Ascension Challenge' }
            ],

            selectedJ: null,
            selectedSlot: null,

            getSlotFromJ: (Jnum) => ((Jnum - 1) % 8) + 1,
            getCycleStart: (Jnum) => Jnum - ((Jnum - 1) % 8),
            sessionKey: (Jnum) => `J${Jnum}`,

            computeCurrentJ: () => {
                normalizeData();
                let j = 1;
                while(data.sessions[training.sessionKey(j)]) j++;
                return j;
            },

            getDifficultyIndex: (lvl) => (lvl<=2?1:(lvl<=4?2:(lvl<=6?3:4))),

            buildExercisesFromNames: (names, durationsSec) =>
                names.map((n,i)=>({ name:n, duration:durationsSec[i] ?? durationsSec[durationsSec.length-1] ?? 120, gif:assets.gifFor(n), vimeo:assets.vimeoFor(n) })),

            getWorkoutDetailsForSlot: (slot) => {
                const getLvl = (m) => app.getFunctionalLevel(m);
                const getCatCode = (lvl) => {
                    const idx = training.getDifficultyIndex(lvl);
                    return idx===1?'beg':idx===2?'int':idx===3?'adv':'exp';
                };

                let primaryMuscleLvl = 1;
                let names = [];
                let structure = [];
                let tier = 1;

                if(slot === 1 || slot === 5) {
                    primaryMuscleLvl = getLvl('Pectoraux');
                    structure = [120,120,120,120];
                    const lvl = getCatCode(primaryMuscleLvl);
                    if(lvl==='beg') names=["Pompes Excentrique","Pompes Genoux Partielles","Pompes Genoux Excentriques","Pompes Corner"];
                    if(lvl==='int') names=["Pompes Dead-Stop","Pompes Jambe Traversante","Pompes Excentriques","Pompes Genoux Partielles"];
                    if(lvl==='adv') names=["Pompes D√©calage Pliom√©triques","Pompes Horloge","Pompes Dead-Stop","Pompes Jambe Traversante"];
                    if(lvl==='exp') names=["Pompes Archer Unilat√©rales","Pompes Diamant","Pompes D√©calage Pliom√©triques","Pompes Horloge"];
                    tier = training.getDifficultyIndex(primaryMuscleLvl);
                }
                else if(slot === 2) {
                    primaryMuscleLvl = getLvl('Jambes');
                    const idx = training.getDifficultyIndex(primaryMuscleLvl);
                    if(idx <= 2) {
                        structure=[240,240];
                        names = (idx===1) ? ["Fentes Arri√®res Basses","Frog Jumps"] : ["Fentes Saut√©es","Fentes Arri√®res Basses"];
                    } else {
                        structure=[480];
                        names = (idx===3) ? ["Single Leg Landmines"] : ["Levitation Squat Unilateral"];
                    }
                    tier = idx;
                }
                else if(slot === 3 || slot === 7) {
                    primaryMuscleLvl = getLvl('Dos');
                    structure=[120,120,120,120];
                    const lvl = getCatCode(primaryMuscleLvl);
                    const rowName = (slot===7) ? "RC" : "Rowing Corner";
                    if(lvl==='beg') names=[`${rowName} Coudes √âcart√©s`,"Chandelier","Superman Row Supination","Snow Angels"];
                    if(lvl==='int') names=[`${rowName} Coudes Tendus`,`${rowName} Coudes √âcart√©s`,"Chandelier","Superman Row Supination"];
                    if(lvl==='adv') names=[`${rowName} Champion`,`${rowName} Coudes Tendus`,`${rowName} Coudes √âcart√©s`,"Chandelier"];
                    if(lvl==='exp') names=[`${rowName} Coudes Serr√©s`,`${rowName} Champion`,`${rowName} Coudes Tendus`,`${rowName} Coudes √âcart√©s`];
                    tier = training.getDifficultyIndex(primaryMuscleLvl);
                }
                else if(slot === 4) {
                    primaryMuscleLvl = getLvl('Triceps');
                    structure=[240,240];
                    const lTri = getCatCode(primaryMuscleLvl);
                    const lBi  = getCatCode(getLvl('Biceps'));
                    let triEx="", biEx="";
                    if(lTri==='beg') triEx="Wall Triceps Extension";
                    else if(lTri==='int') triEx="Pompes du Sphinx";
                    else if(lTri==='adv') triEx="Pompes Tigre Genoux";
                    else triEx="Pompes Tigre";

                    if(lBi==='beg') biEx="Sock Drag Curl";
                    else if(lBi==='int') biEx="Corner Curl Unilat√©ral";
                    else if(lBi==='adv') biEx="Drag Curl au sol";
                    else biEx="Rotation Drag Curl Unilat√©ral";

                    names=[`Triceps ‚Äî ${triEx}`,`Biceps ‚Äî ${biEx}`];
                    tier = training.getDifficultyIndex(primaryMuscleLvl);
                }
                else if(slot === 6) {
                    primaryMuscleLvl = getLvl('Jambes');
                    structure=[240,240];
                    const lvl = getCatCode(primaryMuscleLvl);
                    if(lvl==='beg') names=["Leg Extension de l'Ours","Pont Pi√©tinement"];
                    if(lvl==='int') names=["Corner Sissy Squat","Leg Curl Gliss√© Altern√©"];
                    if(lvl==='adv') names=["Sissy Squat","Leg Curl Gliss√©"];
                    if(lvl==='exp') names=["Sissy Squat Partiel Bas","Leg Curl Gliss√© Unilat√©ral"];
                    tier = training.getDifficultyIndex(primaryMuscleLvl);
                }

                return {
                    tier,
                    exercises: training.buildExercisesFromNames(names, structure),
                    introVimeo:"https://player.vimeo.com/video/000000000"
                };
            },

            init: () => {
                normalizeData();
                const currentJ = training.computeCurrentJ();
                const base = training.getCycleStart(currentJ);

                const grid = document.getElementById('week-grid');
                grid.innerHTML = '';

                for(let i=0;i<8;i++){
                    const Jnum = base + i;
                    const slot = training.getSlotFromJ(Jnum);
                    const label = training.slotLabels[slot-1];

                    const isDone = !!data.sessions[training.sessionKey(Jnum)];
                    const isAvailable = (Jnum === currentJ);
                    const isLocked = (!isDone && !isAvailable);

                    const el = document.createElement('div');
                    el.className = 'day-box' + (isDone ? ' done' : '') + (isLocked ? ' locked' : '');
                    el.innerHTML = `
                        <span style="font-size:1.6em;font-weight:1000;">J${Jnum}</span>
                        <span style="margin-top:4px;">${label.name}</span>
                        ${isDone ? '<span style="margin-top:6px;font-weight:1000;">‚úî</span>' : ''}
                        ${isLocked ? `<img src="verrou.png" class="lock-badge" onerror="this.style.display='none'">` : ''}
                    `;

                    el.onclick = () => {
                        if(isLocked){
                            const prevJ = Jnum - 1;
                            ui.alert("VERROUILL√â", `Vous devez d'abord valider la s√©ance <b>J${prevJ}</b> avant d'affronter <b>J${Jnum}</b>.`);
                            return;
                        }
                        training.openByJ(Jnum);
                    };

                    grid.appendChild(el);
                }

                setTimeout(() => {
                    const btn = document.getElementById('btn-training-retour');
                    if(btn) btn.scrollIntoView({ behavior:'auto', block:'end' });
                    window.scrollTo({ top: 0, behavior:'auto' });
                }, 0);
            },

            resetAllTrainings: () => {
                ui.confirm(
                    "R√âINITIALISATION",
                    "Voulez-vous vraiment <b>r√©initialiser tous les entra√Ænements</b> ?<br><br>Retour √† <b>J1</b> et suppression de <b>toutes les r√©compenses</b>.",
                    () => {
                        // reset trainings + rewards
                        data.sessions = {};
                        data.records = {};
                        data.bossMeta = {};
                        data.bossDefeated = {};
                        data.furyCount = 0;
                        data.furyWeek = { slotsBeaten: {} };
                        data.completedDates = {};
                        data.unstoppableEarned = false;

                        db.save(data);
                        ui.alert("OK", "Tout a √©t√© r√©initialis√©.", () => training.init());
                    }
                );
            },

            openByJ: (Jnum) => {
                training.selectedJ = Jnum;
                training.selectedSlot = training.getSlotFromJ(Jnum);

                if(training.selectedSlot === 8) {
                    ascension.init(Jnum);
                    nav.to('screen-ascension');
                    return;
                }

                const wk = training.getWorkoutDetailsForSlot(training.selectedSlot);

                training.currentExercises = wk.exercises;
                training.currentIndex = 0;
                training.timeLeft = training.currentExercises[0]?.duration || 0;
                training.currentWorkoutIntroVimeo = wk.introVimeo;

                // Boss: depends on slot (1..7) and tier (1..4)
                training.currentTier = wk.tier;
                const tierInfo = BOSS_TIERS.find(t=>t.id===training.currentTier) || BOSS_TIERS[0];
                const bossState = boss.getState(training.selectedSlot, training.currentTier);

                document.getElementById('workout-day-title').innerText = `J${Jnum}: ${training.slotLabels[training.selectedSlot-1].name}`;
                document.getElementById('boss-img-preview').src = tierInfo.img;
                document.getElementById('boss-score-target').innerText = "Score √† battre: " + bossState.target;
                document.getElementById('boss-level-line').innerText = `${tierInfo.name}`;
                document.getElementById('boss-grade-line').innerText = `Grade: ${bossState.gradeName}`;

                const key = training.sessionKey(Jnum);
                if(data.sessions[key]) {
                    document.getElementById('btn-cancel-session').classList.remove('hidden');
                    document.getElementById('workout-score').value = data.sessions[key].score;
                } else {
                    document.getElementById('btn-cancel-session').classList.add('hidden');
                    document.getElementById('workout-score').value = "";
                }

                training.hasAutoScrolledOnFirstStart = false;

                training.timerStopAll();
                training.timerRunning = false;
                training.timerPaused = false;

                training.renderWorkoutUI();
                training.updateTimerUI("Pr√™t ‚Äî exercice 1");
                nav.to('screen-workout');
                window.scrollTo({ top: 0, behavior: 'auto' });
            },

            // WORKOUT UI state
            currentExercises: [],
            currentIndex: 0,
            timeLeft: 0,
            currentWorkoutIntroVimeo: null,
            currentTier: 1,

            scrollListToLast: () => {
                const list = document.getElementById('workout-exercise-list');
                if(!list) return;
                const last = list.lastElementChild;
                if(last && last.scrollIntoView) last.scrollIntoView({ behavior:'smooth', block:'end' });
            },
            scrollToBottom: () => {
                const btn = document.getElementById('btn-workout-retour');
                if(btn && btn.scrollIntoView) btn.scrollIntoView({ behavior:'smooth', block:'end' });
                else window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
            },

            renderWorkoutUI: () => {
                const ex = training.currentExercises[training.currentIndex];
                document.getElementById('exercise-name-current').innerText = ex ? ex.name : "‚Äî";
                document.getElementById('exercise-gif').src = ex ? ex.gif : "https://via.placeholder.com/220x220?text=GIF";
                document.getElementById('exercise-duration').innerText = `‚è±Ô∏è ${training.formatMMSS(ex?.duration || 0)}`;

                const list = document.getElementById('workout-exercise-list');
                list.innerHTML = '';
                training.currentExercises.forEach((e,i) => {
                    const row = document.createElement('div');
                    row.id = `ex-row-${i}`;
                    row.className = 'exercise-row' + (i===training.currentIndex?' current':'') + (i<training.currentIndex?' done':'');
                    row.innerHTML = `
                        <div class="left">
                            <div class="name">${i===training.currentIndex ? "‚ñ∂ " : ""}${e.name}</div>
                            <div class="time">${training.formatMMSS(e.duration)}</div>
                        </div>
                        <div>
                            <span class="exercise-pill ${i<training.currentIndex ? "done" : (i===training.currentIndex ? "current" : "")}">
                                ${i<training.currentIndex ? "FAIT" : (i===training.currentIndex ? "ACTUEL" : "√Ä VENIR")}
                            </span>
                        </div>
                    `;
                    row.onclick = () => training.jumpToExercise(i);
                    list.appendChild(row);
                });

                training.updateControlButtons();
            },

            jumpToExercise: (index) => {
                if(training.timerRunning && !training.timerPaused) {
                    ui.alert("INFO","Mettez le chrono en pause ou attendez la fin de l'exercice avant de changer.");
                    return;
                }
                training.currentIndex = Math.max(0, Math.min(index, training.currentExercises.length-1));
                training.timeLeft = training.currentExercises[training.currentIndex].duration;
                training.timerRunning = false;
                training.timerPaused = false;
                training.timerStopAll();
                training.renderWorkoutUI();
                training.updateTimerUI(`Pr√™t ‚Äî exercice ${training.currentIndex+1}`);
            },

            openWorkoutIntroVideo: () => ui.video("VID√âO ‚Äî s√©ance", training.currentWorkoutIntroVimeo || "https://player.vimeo.com/video/000000000"),

            openCurrentExerciseVideo: () => {
                const ex = training.currentExercises[training.currentIndex];
                ui.video("VID√âO ‚Äî " + (ex?.name || "Exercice"), ex?.vimeo || "https://player.vimeo.com/video/000000000");
            },

            updateTimerUI: (stateText) => {
                document.getElementById('workout-timer-state').innerText = stateText || `Exercice ${training.currentIndex+1}/${training.currentExercises.length}`;
                document.getElementById('workout-timer-digits').innerText = training.formatMMSS(training.timeLeft);
            },

            updateControlButtons: () => {
                const startBtn = document.getElementById('btn-timer-start');
                const pauseBtn = document.getElementById('btn-timer-pause');

                if(training.timerRunning && !training.timerPaused) {
                    startBtn.innerText = "‚ñ∂Ô∏è Reprendre";
                    startBtn.disabled = true; startBtn.style.opacity = 0.5;
                    pauseBtn.disabled = false; pauseBtn.style.opacity = 1;
                } else if(training.timerPaused) {
                    startBtn.innerText = "‚ñ∂Ô∏è Reprendre";
                    startBtn.disabled = false; startBtn.style.opacity = 1;
                    pauseBtn.disabled = true; pauseBtn.style.opacity = 0.5;
                } else {
                    startBtn.innerText = "‚ñ∂Ô∏è D√©marrer";
                    startBtn.disabled = false; startBtn.style.opacity = 1;
                    pauseBtn.disabled = true; pauseBtn.style.opacity = 0.5;
                }
            },

            timerStartOrResume: () => {
                audio.init();
                if(training.currentIndex >= training.currentExercises.length) return;
                if(training.timerRunning && !training.timerPaused) return;

                const isFirstExerciseFirstStart =
                    (training.currentIndex === 0 && !training.hasAutoScrolledOnFirstStart && !training.timerPaused && !training.timerRunning);
                training.hasAutoScrolledOnFirstStart = training.hasAutoScrolledOnFirstStart || isFirstExerciseFirstStart;

                training.timerPaused = false;
                training.timerRunning = true;

                audio.beep('long');
                training.updateControlButtons();
                training.updateTimerUI(`Exercice ${training.currentIndex+1}/${training.currentExercises.length}`);

                if(isFirstExerciseFirstStart) setTimeout(() => training.scrollListToLast(), 200);

                training.timerStopAll();
                training.timerInterval = setInterval(() => {
                    training.timeLeft--;
                    training.updateTimerUI(`Exercice ${training.currentIndex+1}/${training.currentExercises.length}`);
                    if(training.timeLeft <= 3 && training.timeLeft > 0) audio.beep('short');

                    if(training.timeLeft <= 0) {
                        clearInterval(training.timerInterval);
                        training.timerInterval = null;

                        audio.beep('long');

                        training.currentIndex++;
                        training.timerRunning = false;
                        training.timerPaused = false;

                        if(training.currentIndex < training.currentExercises.length) {
                            training.timeLeft = training.currentExercises[training.currentIndex].duration;
                            training.renderWorkoutUI();
                            training.updateTimerUI(`Exercice suivant pr√™t ‚Äî appuyez sur D√©marrer`);
                        } else {
                            training.timeLeft = 0;
                            training.renderWorkoutUI();
                            training.updateTimerUI("TERMIN√â ‚úÖ");

                            ui.alert(
                                "S√âANCE TERMIN√âE ‚úÖ",
                                "Chrono termin√© !<br><br><b>Il reste √† entrer le total de r√©p√©titions</b> et √† <b>valider la s√©ance</b>.",
                                () => training.scrollToBottom()
                            );
                            setTimeout(() => training.scrollToBottom(), 50);
                        }
                        training.updateControlButtons();
                    }
                }, 1000);
            },

            timerPause: () => {
                if(!training.timerRunning || training.timerPaused) return;
                training.timerPaused = true;
                training.timerRunning = false;
                clearInterval(training.timerInterval);
                training.timerInterval = null;
                training.updateTimerUI("Pause");
                training.updateControlButtons();
            },

            timerResetCurrent: () => {
                training.timerStopAll();
                training.timerRunning = false;
                training.timerPaused = false;
                const ex = training.currentExercises[training.currentIndex];
                training.timeLeft = ex ? ex.duration : 0;
                training.updateTimerUI("R√©initialis√©");
                training.updateControlButtons();
            },

            timerStopAll: () => { clearInterval(training.timerInterval); training.timerInterval = null; },

            formatMMSS: (sec) => {
                const s = Math.max(0, sec|0);
                const m = Math.floor(s/60);
                const r = s % 60;
                return `0${m}:${r < 10 ? '0'+r : r}`;
            },

            bumpCompletedDateForSession: (Jkey, newDateISO) => {
                normalizeData();
                const prev = data.sessions[Jkey];
                if(prev && prev.date) {
                    const oldDate = prev.date;
                    if(data.completedDates[oldDate]) {
                        data.completedDates[oldDate]--;
                        if(data.completedDates[oldDate] <= 0) delete data.completedDates[oldDate];
                    }
                }
                data.completedDates[newDateISO] = (data.completedDates[newDateISO] || 0) + 1;
            },

            validateSession: () => {
                normalizeData();

                const score = parseInt(document.getElementById('workout-score').value) || 0;

                const Jnum = training.selectedJ;
                const slot = training.selectedSlot;
                const Jkey = training.sessionKey(Jnum);

                const prevRecord = data.records[Jkey] || 0;

                // boss state
                const bState = boss.getState(slot, training.currentTier);
                const bossTarget = bState.target;
                const tierInfo = BOSS_TIERS.find(t=>t.id===training.currentTier) || BOSS_TIERS[0];

                let msg = "S√©ance valid√©e.";
                if(score > prevRecord && prevRecord > 0) msg += "<br><b>RECORD BATTU !</b>";
                data.records[Jkey] = Math.max(score, prevRecord);

                const today = dateUtil.localISO();
                training.bumpCompletedDateForSession(Jkey, today);

                // Beat The Boss
                const didBeatBoss = (score > bossTarget);
                if(didBeatBoss) {
                    msg += `<br><b>BOSS BATTU !</b>`;
                    boss.beat(slot, training.currentTier);

                    // Fury progression only for non-challenge slots 1..7
                    if(slot >= 1 && slot <= 7) {
                        data.furyWeek.slotsBeaten["slot"+slot] = true;
                        const furyAll = [1,2,3,4,5,6,7].every(s => !!data.furyWeek.slotsBeaten["slot"+s]);
                        if(furyAll) {
                            data.furyCount = (data.furyCount || 0) + 1;
                            data.furyWeek.slotsBeaten = {};
                            msg += "<br><b>TROPH√âE GAGN√â : FURIE !</b>";
                        }
                    }

                    // refresh boss display immediately (next grade/target)
                    const newState = boss.getState(slot, training.currentTier);
                    document.getElementById('boss-score-target').innerText = "Score √† battre: " + newState.target;
                    document.getElementById('boss-grade-line').innerText = "Grade: " + newState.gradeName;
                    document.getElementById('boss-level-line').innerText = `${tierInfo.name}`;
                }

                // Unstoppable
                const before = !!data.unstoppableEarned;
                const current = streak.currentStreakDays();
                if(!data.unstoppableEarned && current >= 21) data.unstoppableEarned = true;
                if(!before && data.unstoppableEarned) msg += "<br><b>TROPH√âE GAGN√â : UNSTOPPABLE !</b>";

                data.sessions[Jkey] = {
                    validated: true,
                    score: score,
                    date: today,
                    undoData: {
                        didBeatBoss,
                        slot,
                        tier: training.currentTier,
                        bossGradeAtWin: bState.gradeIndex,
                        bossTargetAtWin: bossTarget
                    }
                };

                db.save(data);

                ui.alert("F√âLICITATIONS", msg, () => {
                    training.init();         // this will automatically jump to next J (J8 -> J9 -> ...)
                    nav.to('screen-training');
                });
            },

            cancelSession: () => {
                ui.confirm("ANNULATION", "Voulez-vous vraiment annuler cette s√©ance ? Cela effacera le statut valid√© et les r√©compenses associ√©es.", () => {
                    normalizeData();
                    const Jnum = training.selectedJ;
                    const Jkey = training.sessionKey(Jnum);
                    const session = data.sessions[Jkey];

                    // remove completed date count
                    if(session && session.date) {
                        const d = session.date;
                        if(data.completedDates[d]) {
                            data.completedDates[d]--;
                            if(data.completedDates[d] <= 0) delete data.completedDates[d];
                        }
                    }

                    // NOTE: We do NOT roll back boss grade/target history when canceling (too complex + avoids exploits).
                    // We simply remove the session validation (progression lock will update accordingly via computeCurrentJ()).

                    delete data.sessions[Jkey];
                    db.save(data);

                    ui.alert("INFO", "S√©ance annul√©e.", () => {
                        training.init();
                        nav.to('screen-training');
                    });
                });
            },

            quit: () => {
                training.timerStopAll();
                training.timerRunning = false;
                training.timerPaused = false;
                nav.to('screen-training');
            }
        };

        // --- ASCENSION (slot 8) ---
        const ascension = {
            currentJ: 8,
            totalSeconds: 8*60,
            interval: null,
            running: false,
            paused: false,
            targetReps: 10,
            palierCompleted: 0,
            stepIndex: 0,
            exercises: [],
            introVimeo: "https://player.vimeo.com/video/000000000",

            init: (Jnum) => {
                ascension.currentJ = Jnum;
                document.getElementById('asc-title').innerText = `J${Jnum} ‚Äî Ascension Challenge`;

                ascension.stop();
                ascension.totalSeconds = 8*60;
                ascension.running = false;
                ascension.paused = false;
                ascension.targetReps = 10;
                ascension.palierCompleted = 0;
                ascension.stepIndex = 0;

                // J1 second exercise depends on pec level
                const j1 = training.getWorkoutDetailsForSlot(1);
                const secondEx = j1.exercises[1] ? j1.exercises[1].name : "Exercice J1-2";

                ascension.exercises = [
                    { name: secondEx, gif: assets.gifFor(secondEx), vimeo: assets.vimeoFor(secondEx) },
                    { name: "Fentes du sprinteur (Gauche)", gif: assets.gifFor("Fentes du sprinteur (Gauche)"), vimeo: assets.vimeoFor("Fentes du sprinteur (Gauche)") },
                    { name: "Fentes du sprinteur (Droite)", gif: assets.gifFor("Fentes du sprinteur (Droite)"), vimeo: assets.vimeoFor("Fentes du sprinteur (Droite)") },
                    { name: "Side Elbow Press-Up (Gauche)", gif: assets.gifFor("Side Elbow Press-Up (Gauche)"), vimeo: assets.vimeoFor("Side Elbow Press-Up (Gauche)") },
                    { name: "Side Elbow Press-Up (Droite)", gif: assets.gifFor("Side Elbow Press-Up (Droite)"), vimeo: assets.vimeoFor("Side Elbow Press-Up (Droite)") }
                ];

                const hasSession = !!data.sessions[`J${Jnum}`];
                document.getElementById('btn-asc-cancel').classList.toggle('hidden', !hasSession);

                ascension.render();
                ascension.updateTimerUI("Pr√™t");
                window.scrollTo({ top: 0, behavior: 'auto' });
            },

            render: () => {
                document.getElementById('asc-palier-title').innerText = `Palier ${ascension.targetReps} r√©p√©titions`;
                document.getElementById('asc-do-now').innerHTML = `Fa√Ætes <b style="color:var(--accent-yellow);">${ascension.targetReps}</b> r√©p√©titions`;
                document.getElementById('asc-target-inline').innerText = ascension.targetReps;

                const ex = ascension.exercises[ascension.stepIndex];
                document.getElementById('asc-exercise-name').innerText = ex ? ex.name : "‚Äî";
                document.getElementById('asc-gif').src = ex ? ex.gif : "https://via.placeholder.com/220x220?text=GIF";
                document.getElementById('asc-step-pill').innerText = `EX ${ascension.stepIndex+1}/${ascension.exercises.length}`;

                const exDoneInCurrentPalier = ascension.stepIndex;
                document.getElementById('asc-progress-pill').innerText = `Paliers: ${ascension.palierCompleted} ‚Ä¢ Ex: ${exDoneInCurrentPalier}`;

                const list = document.getElementById('asc-exercise-list');
                list.innerHTML = "";
                ascension.exercises.forEach((e, i) => {
                    const row = document.createElement('div');
                    row.className = 'exercise-row' + (i===ascension.stepIndex?' current':'') + (i<ascension.stepIndex?' done':'');
                    row.innerHTML = `
                        <div class="left">
                            <div class="name">${i===ascension.stepIndex ? "‚ñ∂ " : ""}${e.name}</div>
                            <div class="time">Objectif: ${ascension.targetReps} r√©p√©titions</div>
                        </div>
                        <div>
                            <span class="exercise-pill ${i<ascension.stepIndex ? "done" : (i===ascension.stepIndex ? "current" : "")}">
                                ${i<ascension.stepIndex ? "FAIT" : (i===ascension.stepIndex ? "ACTUEL" : "√Ä VENIR")}
                            </span>
                        </div>
                    `;
                    row.onclick = () => ui.video("VID√âO ‚Äî " + e.name, e.vimeo);
                    list.appendChild(row);
                });
            },

            updateTimerUI: (state) => {
                const m = Math.floor(ascension.totalSeconds / 60);
                const s = ascension.totalSeconds % 60;
                document.getElementById('asc-timer-digits').innerText = `0${m}:${s<10?'0'+s:s}`;
                document.getElementById('asc-timer-state').innerText = state || "En cours...";
            },

            openIntroVideo: () => ui.video("VID√âO ‚Äî Ascension Challenge", ascension.introVimeo),
            openCurrentVideo: () => {
                const ex = ascension.exercises[ascension.stepIndex];
                ui.video("VID√âO ‚Äî " + (ex?.name||"Exercice"), ex?.vimeo || "https://player.vimeo.com/video/000000000");
            },

            start: () => {
                if(ascension.running) return;
                audio.init();
                ascension.running = true;
                ascension.paused = false;
                audio.beep('long');

                clearInterval(ascension.interval);
                ascension.interval = setInterval(() => {
                    ascension.totalSeconds--;
                    if(ascension.totalSeconds <= 3 && ascension.totalSeconds > 0) audio.beep('short');
                    ascension.updateTimerUI("En cours...");
                    if(ascension.totalSeconds <= 0) ascension.finish();
                }, 1000);
            },

            pause: () => {
                if(!ascension.running) return;
                ascension.running = false;
                ascension.paused = true;
                clearInterval(ascension.interval);
                ascension.interval = null;
                ascension.updateTimerUI("Pause");
            },

            reset: () => ui.confirm("RESET", "R√©initialiser compl√®tement le challenge ? (timer + progression)", () => ascension.init(ascension.currentJ)),

            validate: () => {
                if(ascension.totalSeconds <= 0) return;
                audio.init();
                audio.beep('long');

                ascension.stepIndex++;
                if(ascension.stepIndex >= ascension.exercises.length) {
                    ascension.palierCompleted++;
                    ascension.stepIndex = 0;
                    ascension.targetReps += 2;
                }
                ascension.render();
                const card = document.getElementById('asc-current-card');
                if(card) card.scrollIntoView({ behavior:'smooth', block:'start' });
            },

            finish: () => {
                clearInterval(ascension.interval);
                ascension.interval = null;
                ascension.running = false;

                audio.beep('end');

                const exercisesDoneInCurrentPalier = ascension.stepIndex;
                const score = (ascension.palierCompleted * 10) + exercisesDoneInCurrentPalier;

                const html = `
                    <div style="font-size:2.6em;font-weight:1000;color:var(--accent-yellow);margin-bottom:10px;">${score}</div>
                    <div class="subtle" style="text-align:left;">
                        <b>Paliers compl√©t√©s :</b> ${ascension.palierCompleted}<br>
                        <b>Exercices compl√©t√©s</b> dans le palier en cours : ${exercisesDoneInCurrentPalier} / ${ascension.exercises.length}<br><br>
                        <b>Formule :</b> paliers √ó10 + exercices (palier en cours)
                    </div>
                `;

                ui.show("CHALLENGE TERMIN√â ‚úÖ", html, [
                    { text: "ENREGISTRER", class: "btn-modal-confirm", onClick: () => ascension.saveScore(score) },
                    { text: "RETOUR", class: "btn-modal-cancel", onClick: () => { training.init(); nav.to('screen-training'); } }
                ]);
            },

            saveScore: (score) => {
                normalizeData();
                const Jkey = `J${ascension.currentJ}`;

                const prevRecord = data.records[Jkey] || 0;
                data.records[Jkey] = Math.max(prevRecord, score);

                const today = dateUtil.localISO();
                training.bumpCompletedDateForSession(Jkey, today);

                const before = !!data.unstoppableEarned;
                const current = streak.currentStreakDays();
                if(!data.unstoppableEarned && current >= 21) data.unstoppableEarned = true;

                data.sessions[Jkey] = { validated:true, score:score, date: today, undoData:{ didBeatBoss:false } };
                db.save(data);

                document.getElementById('btn-asc-cancel').classList.remove('hidden');

                let msg = `Score enregistr√© (J${ascension.currentJ}).`;
                if(!before && data.unstoppableEarned) msg += "<br><b>TROPH√âE GAGN√â : UNSTOPPABLE !</b>";

                ui.alert("OK", msg, () => { training.init(); nav.to('screen-training'); });
            },

            cancel: () => {
                ui.confirm("ANNULATION", "Voulez-vous vraiment annuler / invalider ce challenge ? Cela retirera la validation de la s√©ance.", () => {
                    normalizeData();
                    const Jkey = `J${ascension.currentJ}`;
                    const session = data.sessions[Jkey];

                    if(session && session.date) {
                        const d = session.date;
                        if(data.completedDates[d]) {
                            data.completedDates[d]--;
                            if(data.completedDates[d] <= 0) delete data.completedDates[d];
                        }
                    }

                    delete data.sessions[Jkey];
                    db.save(data);

                    document.getElementById('btn-asc-cancel').classList.add('hidden');
                    ui.alert("INFO", `S√©ance J${ascension.currentJ} invalid√©e.`, () => { training.init(); nav.to('screen-training'); });
                });
            },

            stop: () => { clearInterval(ascension.interval); ascension.interval = null; },
            quit: () => { ascension.stop(); nav.to('screen-training'); }
        };

        // --- GALLERY ---
        const gallery = {
            setLocked: (cardId, locked) => {
                const el = document.getElementById(cardId);
                if(!el) return;
                if(locked) el.classList.add('locked');
                else el.classList.remove('locked');
            },

            render: () => {
                normalizeData();

                document.getElementById('trophy-char-img').src = app.getCharImage(app.getGlobalLevel());

                const recordCount = Object.keys(data.records).filter(k => (data.records[k] || 0) > 0).length;
                document.getElementById('total-records').innerText = recordCount;
                gallery.setLocked('card-records', recordCount <= 0);

                const fury = data.furyCount || 0;
                document.getElementById('fury-count-display').innerText = fury;
                gallery.setLocked('card-fury', fury <= 0);

                const hasUnstoppable = !!data.unstoppableEarned;
                document.getElementById('unstoppable-display').innerText = hasUnstoppable ? "‚úì" : "0";
                gallery.setLocked('card-unstoppable', !hasUnstoppable);

                const rem = streak.remainingToUnstoppable();
                const remEl = document.getElementById('unstoppable-remaining');
                if(hasUnstoppable) {
                    remEl.innerText = "(obtenu)";
                    remEl.style.opacity = 0.7;
                } else {
                    remEl.innerText = `(encore ${rem} jours)`;
                    remEl.style.opacity = 0.95;
                }

                const lvl = app.getGlobalLevel();
                const thresholds = [10,15,19,23,26,29,32,34,36,38,39,40];
                const next = thresholds.find(t => t > lvl);
                let evoText = "";
                if(next) {
                    const diff = next - lvl;
                    evoText = `Plus que ${diff} niveau${diff > 1 ? 'x' : ''} avant √©volution !`;
                } else if (lvl >= 40) evoText = "Niveau Maximum atteint !";
                else evoText = "Continuez l'entra√Ænement !";
                document.getElementById('trophy-next-evo').innerText = evoText;

                // Boss Vaincus: show all grades per tier (aggregate across slots), grey if 0
                const bossContainer = document.getElementById('boss-trophy-container');
                bossContainer.innerHTML = '';

                for(const tierInfo of BOSS_TIERS){
                    for(let g=0; g<BOSS_GRADES.length; g++){
                        const count = boss.sumDefeated(tierInfo.id, g);

                        const div = document.createElement('div');
                        div.className = 'stat-card' + (count <= 0 ? ' locked' : '');

                        div.innerHTML = `
                            <img src="${tierInfo.img}" class="stat-icon" onerror="this.src='https://via.placeholder.com/130?text=Boss'">
                            <span class="stat-value">x${count}</span>
                            <span class="stat-label">Boss ${tierInfo.name}</span>
                            <div class="tiny-under">${BOSS_GRADES[g]}</div>
                        `;

                        div.onclick = () => {
                            ui.alert("BOSS VAINCU", `<b>${tierInfo.name}</b><br>${BOSS_GRADES[g]}`);
                        };

                        bossContainer.appendChild(div);
                    }
                }
            },

            explain: (type) => {
                if(type === 'records') {
                    ui.alert("TROPH√âE ‚Äî RECORDS", `
                        <b>Records Battus</b><br><br>
                        Nombre de s√©ances o√π vous avez enregistr√© un score record.<br>
                        Astuce : refaites la m√™me s√©ance et tentez d'augmenter votre <b>total de r√©p√©titions</b>.
                    `);
                    return;
                }
                if(type === 'fury') {
                    ui.alert("TROPH√âE ‚Äî FURIE", `
                        <b>Furie</b><br><br>
                        Gagn√© lorsque vous terrassez le <b>Boss</b> de chacun des <b>7 jours</b> (hors challenge) dans une m√™me semaine.
                    `);
                    return;
                }
                if(type === 'unstoppable') {
                    const s = streak.currentStreakDays();
                    const rem = streak.remainingToUnstoppable();
                    ui.alert("TROPH√âE ‚Äî UNSTOPPABLE", `
                        <b>Unstoppable</b><br><br>
                        Gagn√© apr√®s <b>21 jours cons√©cutifs</b> d'entra√Ænements valid√©s.<br><br>
                        <b>S√©rie actuelle :</b> ${s} jour${s>1?'s':''}<br>
                        <b>Encore :</b> ${rem} jour${rem>1?'s':''}
                    `);
                    return;
                }
            },

            resetTrophies: () => {
                ui.confirm("RESET", "Voulez-vous vraiment effacer TOUTES vos r√©compenses ?<br><br>√áa n'affecte pas votre niveau de tests.", () => {
                    normalizeData();
                    data.bossMeta = {};
                    data.bossDefeated = {};
                    data.records = {};
                    data.furyCount = 0;
                    data.furyWeek = { slotsBeaten: {} };
                    data.completedDates = {};
                    data.unstoppableEarned = false;
                    db.save(data);
                    gallery.render();
                    ui.alert("TERMINE", "Toutes les r√©compenses ont √©t√© effac√©es.");
                });
            }
        };

        // --- NAV ---
        const nav = {
            to: (id) => {
                document.querySelectorAll('.container').forEach(d => d.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                if(id === 'screen-menu') app.updateCharacter();
                if(id === 'screen-training') training.init();
                if(id === 'screen-trophy') gallery.render();
            }
        };

        // --- INIT ---
        document.getElementById('screen-menu').classList.remove('hidden');
        app.updateCharacter();
        lightning.init();

        if('serviceWorker' in navigator){
            window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
        }
    </script>
</body>
</html>
