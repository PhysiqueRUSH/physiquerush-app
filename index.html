<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysiqueRush</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --accent-pink: #ff6ec7;   /* Débutant */
            --accent-green: #4caf50;  /* Intermédiaire */
            --accent-yellow: #ffeb3b; /* Avancé */
            --accent-red: #f44336;    /* Expert */
            --card-bg: #1e1e1e;
        }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: var(--card-bg); color: white; border: 1px solid #333; cursor: pointer; text-align: center; font-weight: bold; text-transform: uppercase; border-radius: 8px; transition: 0.2s; }
        .btn:hover { background: #333; }
        .btn-red { background: var(--accent-red); color: black; border: none; }
        .container { width: 95%; max-width: 500px; padding: 20px; text-align: center; }
        
        /* Header / Character */
        #char-display { margin-bottom: 20px; }
        #char-img { max-width: 150px; display: block; margin: 0 auto; }
        #global-level-badge { font-size: 1.2em; font-weight: bold; margin-top: 10px; color: var(--accent-yellow); }

        /* Levels Room */
        #radar-container { position: relative; width: 100%; height: 300px; margin-bottom: 20px; background: #000; border-radius: 10px; }
        canvas { display: block; width: 100%; height: 100%; }

        /* Training Camp */
        .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 20px; }
        .day-box { background: #333; padding: 10px 2px; font-size: 0.8em; border-radius: 4px; cursor: pointer; opacity: 0.5; }
        .day-box.active { border: 2px solid var(--accent-yellow); opacity: 1; }
        .day-box.done { background: var(--accent-green); color: black; opacity: 1; }
        
        /* Inputs & Rewards */
        input[type="number"] { width: 80px; padding: 10px; text-align: center; border-radius: 5px; border: none; }
        .trophy-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; }
        .trophy-item { width: 80px; cursor: pointer; text-align: center; }
        .trophy-item img { width: 60px; height: 60px; object-fit: contain; }
        
        .whatsapp-icon { width: 20px; vertical-align: middle; margin-left: 10px; }
    </style>
</head>
<body>

    <div id="screen-menu" class="container">
        <div id="char-display">
            <img id="char-img" src="evo1.png" alt="Character" onerror="this.src='https://via.placeholder.com/150x200?text=Perso+Manquant'">
            <div id="global-level-badge">Niveau 5</div>
        </div>
        
        <button class="btn" onclick="nav.to('screen-levels')">LEVELS ROOM</button>
        <button class="btn" onclick="nav.to('screen-training')">TRAINING CAMP</button>
        <button class="btn" onclick="alert('Module Nutri-Rush bientôt disponible.')">NUTRI-RUSH</button>
        <button class="btn" onclick="nav.to('screen-trophy')">Galerie des Trophées</button>
        <button class="btn" onclick="window.location.href='https://wa.me/'">La Team PhysiqueRush <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" class="whatsapp-icon"></button>
        <button class="btn btn-red" onclick="window.close()">Quitter</button>
    </div>

    <div id="screen-levels" class="container hidden">
        <h2>LEVELS ROOM</h2>
        <button class="btn" onclick="evoLab.init()">Evolution Lab</button>
        <button class="btn" onclick="tests.start('Pectoraux')">Test Pectoraux</button>
        <button class="btn" onclick="tests.start('Jambes')">Test Jambes</button>
        <button class="btn" onclick="tests.start('Dos')">Test Dos</button>
        <button class="btn" onclick="tests.start('Triceps')">Test Triceps</button>
        <button class="btn" onclick="tests.start('Biceps')">Test Biceps</button>
        <button class="btn" onclick="nav.to('screen-menu')">Retour</button>
    </div>

    <div id="screen-evolab" class="container hidden">
        <h3>Evolution Lab</h3>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <button onclick="evoLab.showOriginal()" style="background:none; border:none; color: white; cursor: pointer;">◄ Origine</button>
            <span id="evolab-title">Actuel</span>
            <button onclick="evoLab.showCurrent()" style="background:none; border:none; color: white; cursor: pointer;">Actuel ►</button>
        </div>
        <div id="radar-container">
            <canvas id="radarChart"></canvas>
        </div>
        <div id="evolab-global">Niveau Global: 5</div>
        <button class="btn" onclick="nav.to('screen-levels')">Retour</button>
    </div>

    <div id="screen-test" class="container hidden">
        <h2 id="test-name">Test</h2>
        <div style="background: #000; height: 150px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; color: #555;">
            [VIDEO VIMEO PLACEHOLDER]
        </div>
        <h3 id="test-exercise-name">Exercice</h3>
        <div id="timer-display" style="font-size: 3em; font-weight: bold; margin: 20px 0;">00:00</div>
        <div id="reps-target" style="color: var(--accent-yellow); font-size: 1.2em;">Objectif: 10 reps</div>
        <div id="current-palier" style="margin-bottom: 20px;">Palier 1</div>
        
        <button id="btn-start-test" class="btn btn-red" onclick="tests.run()">LANCER LE TEST</button>
        <button id="btn-fail-test" class="btn hidden" onclick="tests.fail()">Echec / Fin</button>
        <button class="btn" onclick="tests.quit()">Retour</button>
    </div>

    <div id="screen-training" class="container hidden">
        <h2>TRAINING CAMP</h2>
        <div class="week-grid" id="week-grid">
            </div>
        <div id="training-info" style="margin-top: 20px;">
            Sélectionnez un jour.
        </div>
        <button class="btn" onclick="nav.to('screen-menu')">Retour</button>
    </div>

    <div id="screen-workout" class="container hidden">
        <h2 id="workout-day-title">Jour X</h2>
        <div style="background: #000; height: 150px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; color: #555;">
            [VIDEO VIMEO SEANCE]
        </div>
        <div id="workout-list" style="text-align: left; margin-bottom: 20px;">
            </div>
        
        <div class="boss-section" style="border: 1px solid #444; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
            <h4>Beat The Boss</h4>
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                <img id="boss-img-preview" src="" style="width: 80px; height: 80px; object-fit: contain; border-radius: 10px;" onerror="this.src='https://via.placeholder.com/80?text=BTB'">
                <span id="boss-score-target" style="font-weight: bold; color: var(--accent-red);">Score à battre: ???</span>
            </div>
        </div>

        <input type="number" id="workout-score" placeholder="Score">
        <button class="btn btn-red" onclick="training.validateSession()">VALIDER LA SEANCE</button>
        <button class="btn" onclick="nav.to('screen-training')">Retour</button>
    </div>

    <div id="screen-trophy" class="container hidden">
        <h2>Galerie des Trophées</h2>
        <div style="margin-bottom: 30px;">
            <img id="trophy-char-img" src="" style="width: 100px; margin: 0 auto; display: block;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px;">
                <img src="record.png" onerror="this.src='https://via.placeholder.com/50?text=Rec'" style="width: 40px;">
                <span id="total-records" style="font-size: 1.5em; font-weight: bold;">0</span>
            </div>
        </div>
        
        <div id="boss-trophy-container" class="trophy-grid">
            </div>
        <div id="fury-container" class="trophy-grid" style="margin-top: 20px;">
             </div>

        <button class="btn" style="margin-top: 30px;" onclick="nav.to('screen-menu')">Retour</button>
    </div>

    <script>
        // --- DATA & STATE MANAGEMENT ---
        const db = {
            load: () => JSON.parse(localStorage.getItem('physiqueRushDB')) || db.default(),
            save: (data) => localStorage.setItem('physiqueRushDB', JSON.stringify(data)),
            default: () => ({
                stats: { Pectoraux: 1, Jambes: 1, Dos: 1, Triceps: 1, Biceps: 1 },
                history: { originalStats: { Pectoraux: 1, Jambes: 1, Dos: 1, Triceps: 1, Biceps: 1 } },
                sessions: {}, 
                records: {}, 
                bossBeaten: {}, 
                furyCount: 0
            })
        };

        let data = db.load();

        // --- CORE LOGIC ---
        const app = {
            getGlobalLevel: () => {
                let sum = 0;
                for(let k in data.stats) sum += data.stats[k];
                return sum;
            },
            getCharImage: (level) => {
                if(level <= 10) return 'evo1.png';
                if(level <= 15) return 'evo2.png';
                if(level <= 19) return 'evo3.png';
                if(level <= 23) return 'evo4.png';
                if(level <= 26) return 'evo5.png';
                if(level <= 29) return 'evo6.png';
                if(level <= 32) return 'evo7.png';
                if(level <= 34) return 'evo8.png';
                if(level <= 36) return 'evo9.png';
                if(level <= 38) return 'evo10.png';
                if(level === 39) return 'evo11.png';
                return 'evo12.png';
            },
            updateCharacter: () => {
                const lvl = app.getGlobalLevel();
                const imgName = app.getCharImage(lvl);
                document.getElementById('char-img').src = imgName; 
                document.getElementById('global-level-badge').innerText = "Niveau " + lvl;
            },
            getLevelColor: (val) => {
                if(val <= 2) return '#ff6ec7'; // Debutant
                if(val <= 4) return '#4caf50'; // Inter
                if(val <= 6) return '#ffeb3b'; // Avancé
                return '#f44336'; // Expert
            }
        };

        // --- LEVELS ROOM ---
        const tests = {
            currentTest: null,
            interval: null,
            currentPalier: 1,
            
            config: {
                'Pectoraux': 'Pompes Dead-Stop',
                'Jambes': 'Fentes Sautées',
                'Dos': 'Rowing Corner Coudes Écartés',
                'Triceps': 'Dips Chaise Jambes Tendues',
                'Biceps': 'Drag Curl au Sol'
            },

            start: (muscle) => {
                tests.currentTest = muscle;
                tests.currentPalier = 1;
                document.getElementById('test-name').innerText = "Test " + muscle;
                document.getElementById('test-exercise-name').innerText = tests.config[muscle];
                document.getElementById('timer-display').innerText = "08:00";
                document.getElementById('reps-target').innerText = "Objectif: 10 reps";
                document.getElementById('current-palier').innerText = "Palier 1";
                document.getElementById('btn-start-test').classList.remove('hidden');
                document.getElementById('btn-fail-test').classList.add('hidden');
                nav.to('screen-test');
            },
            
            run: () => {
                document.getElementById('btn-start-test').classList.add('hidden');
                document.getElementById('btn-fail-test').classList.remove('hidden');
                let totalSeconds = 8 * 60;
                let secondsInMinute = 60;
                let palier = 1;
                let reps = 10;

                tests.interval = setInterval(() => {
                    totalSeconds--;
                    secondsInMinute--;
                    let min = Math.floor(totalSeconds / 60);
                    let sec = totalSeconds % 60;
                    document.getElementById('timer-display').innerText = `0${min}:${sec < 10 ? '0'+sec : sec}`;

                    if (secondsInMinute <= 0) {
                        if (totalSeconds <= 0) {
                            tests.finish(8); 
                            return;
                        }
                        palier++;
                        reps += 2;
                        secondsInMinute = 60;
                        document.getElementById('current-palier').innerText = "Palier " + palier;
                        document.getElementById('reps-target').innerText = "Objectif: " + reps + " reps";
                        tests.currentPalier = palier;
                    }
                }, 1000); 
            },

            fail: () => {
                let validated = tests.currentPalier > 1 ? tests.currentPalier - 1 : 1;
                tests.finish(validated);
            },

            finish: (score) => {
                clearInterval(tests.interval);
                data.stats[tests.currentTest] = score;
                db.save(data);
                alert(`Test terminé. Palier validé : ${score}`);
                nav.to('screen-levels');
            },

            quit: () => {
                clearInterval(tests.interval);
                nav.to('screen-levels');
            }
        };

        // --- EVOLUTION LAB ---
        const evoLab = {
            chart: null,
            init: () => {
                nav.to('screen-evolab');
                evoLab.render(data.stats);
                document.getElementById('evolab-title').innerText = "Actuel";
                document.getElementById('evolab-global').innerText = "Niveau Global: " + app.getGlobalLevel();
            },
            showOriginal: () => {
                evoLab.render(data.history.originalStats);
                document.getElementById('evolab-title').innerText = "Origine";
            },
            showCurrent: () => {
                evoLab.init();
            },
            render: (statsObj) => {
                const ctx = document.getElementById('radarChart').getContext('2d');
                const values = [statsObj.Pectoraux, statsObj.Jambes, statsObj.Dos, statsObj.Triceps, statsObj.Biceps];
                const pointColors = values.map(v => app.getLevelColor(v));

                if(evoLab.chart) evoLab.chart.destroy();

                evoLab.chart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['Pectoraux', 'Jambes', 'Dos', 'Triceps', 'Biceps'],
                        datasets: [{
                            data: values,
                            backgroundColor: 'rgba(255, 255, 255, 0.2)',
                            borderColor: '#fff',
                            pointBackgroundColor: pointColors,
                            pointBorderColor: '#fff',
                            pointRadius: 5
                        }]
                    },
                    options: {
                        scales: {
                            r: {
                                min: 0, max: 8,
                                ticks: { stepSize: 1, backdropColor: 'transparent', color: '#666' },
                                grid: { color: '#333' },
                                pointLabels: { color: '#fff' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        };

        // --- TRAINING CAMP ---
        const training = {
            days: [
                { id: 1, name: 'Pectoraux' },
                { id: 2, name: 'Jambes (Poly)' },
                { id: 3, name: 'Dos' },
                { id: 4, name: 'Tri/Bi' },
                { id: 5, name: 'Pectoraux' },
                { id: 6, name: 'Jambes (Iso)' },
                { id: 7, name: 'Dos' }
            ],
            
            getDifficultyIndex: (lvl) => {
                if(lvl<=2) return 1; // Beg
                if(lvl<=4) return 2; // Int
                if(lvl<=6) return 3; // Adv
                return 4;            // Exp
            },

            getExercises: (dayId) => {
                const getLvl = (m) => data.stats[m] || 1;
                const getCatCode = (lvl) => {
                    const idx = training.getDifficultyIndex(lvl);
                    return idx === 1 ? 'beg' : idx === 2 ? 'int' : idx === 3 ? 'adv' : 'exp';
                };

                let content = "";
                let primaryMuscleLvl = 1;

                // --- DAY 1 & 5: PECTORAUX ---
                if(dayId === 1 || dayId === 5) { 
                    primaryMuscleLvl = getLvl('Pectoraux');
                    const lvl = getCatCode(primaryMuscleLvl);
                    if(lvl === 'beg') content = "2' Pompes Excentrique > 2' Pompes Genoux Partielles > 2' Pompes Genoux Excentriques > 2' Pompes Corner";
                    if(lvl === 'int') content = "Pompes Dead-Stop > Pompes Jambe Traversante > Pompes Excentriques > Pompes Genoux Partielles";
                    if(lvl === 'adv') content = "Pompes Décalage Pliométriques > Pompes Horloge > Pompes Dead-Stop > Pompes Jambe Traversante";
                    if(lvl === 'exp') content = "Pompes Archer Unilatérales > Pompes Diamant > Pompes Décalage Pliométriques > Pompes Horloge";
                }
                
                // --- DAY 2: JAMBES POLYARTICULAIRE ---
                else if(dayId === 2) { 
                    primaryMuscleLvl = getLvl('Jambes');
                    const lvl = getCatCode(primaryMuscleLvl);
                    if(lvl === 'beg') content = "4' Fentes Arrières Basses > 4' Frog Jumps";
                    if(lvl === 'int') content = "4' Fentes Sautées > 4' Fentes Arrières Basses";
                    if(lvl === 'adv') content = "8' Single Leg Landmines";
                    if(lvl === 'exp') content = "8' Levitation Squat Unilateral";
                }
                
                // --- DAY 3 & 7: DOS ---
                else if(dayId === 3 || dayId === 7) { 
                    primaryMuscleLvl = getLvl('Dos');
                    const lvl = getCatCode(primaryMuscleLvl);
                    let rowName = "Rowing Corner";
                    // Simplification for Day 7: if it is day 7, use RC.
                    if(dayId === 7) rowName = "RC";

                    if(lvl === 'beg') content = `${rowName} Coudes Écartés > Chandelier > Superman Row Supination > Snow Angels`;
                    if(lvl === 'int') content = `${rowName} Coudes Tendus > ${rowName} Coudes Écartés > Chandelier > Superman Row Supination`;
                    if(lvl === 'adv') content = `${rowName} Champion > ${rowName} Coudes Tendus > ${rowName} Coudes Écartés > Chandelier`;
                    if(lvl === 'exp') content = `${rowName} Coudes Serrés > ${rowName} Champion > ${rowName} Coudes Tendus > ${rowName} Coudes Écartés`;
                }
                
                // --- DAY 4: TRICEPS / BICEPS ---
                else if(dayId === 4) { 
                    primaryMuscleLvl = getLvl('Triceps'); // Boss determined by Triceps
                    const lTri = getCatCode(primaryMuscleLvl);
                    const lBi = getCatCode(getLvl('Biceps'));
                    
                    let triEx=""; 
                    if(lTri === 'beg') triEx = "Wall Triceps Extension"; 
                    else if(lTri === 'int') triEx = "Pompes du Sphinx"; 
                    else if(lTri === 'adv') triEx = "Pompes Tigre sur les Genoux"; 
                    else triEx = "Pompes Tigre";

                    let biEx="";
                    if(lBi === 'beg') biEx = "Sock Drag Curl"; 
                    else if(lBi === 'int') biEx = "Corner Curl Unilatéral"; 
                    else if(lBi === 'adv') biEx = "Drag Curl au sol"; 
                    else biEx = "Rotation Drag Curl Unilatéral";
                    
                    content = `Triceps (4'): ${triEx} <br><br> Biceps (4'): ${biEx}`;
                }
                
                // --- DAY 6: JAMBES ISOLATION ---
                else if(dayId === 6) { 
                    primaryMuscleLvl = getLvl('Jambes');
                    const lvl = getCatCode(primaryMuscleLvl);
                    if(lvl === 'beg') content = "4' Leg Extension de l'Ours > 4' Pont Piétinement";
                    if(lvl === 'int') content = "4' Corner Sissy Squat > 4' Leg Curl Glissé Alterné";
                    if(lvl === 'adv') content = "4' Sissy Squat > 4' Leg Curl Glissé";
                    if(lvl === 'exp') content = "4' Sissy Squat Partiel Bas > 4' Leg Curl Glissé Unilatéral";
                }

                // Determine Boss Image based on Difficulty Index (1-4) of the primary muscle group
                const diffIdx = training.getDifficultyIndex(primaryMuscleLvl);
                const bossImg = `btb${diffIdx}.png`;

                return { desc: content, bossTarget: 100, bossImg: bossImg, bossId: diffIdx };
            },

            selectedDay: null,
            currentBossId: null,

            init: () => {
                const grid = document.getElementById('week-grid');
                grid.innerHTML = '';
                // Render Days 1-7
                training.days.forEach(d => {
                    const el = document.createElement('div');
                    el.className = 'day-box';
                    el.innerText = `J${d.id}\n${d.name}`;
                    if(data.sessions['day'+d.id]) el.classList.add('done');
                    el.onclick = () => training.openDay(d.id);
                    grid.appendChild(el);
                });
            },

            openDay: (dayId) => {
                training.selectedDay = dayId;
                const workoutData = training.getExercises(dayId);
                
                document.getElementById('workout-day-title').innerText = `Jour ${dayId}: ${training.days[dayId-1].name}`;
                document.getElementById('workout-list').innerHTML = workoutData.desc;
                document.getElementById('boss-score-target').innerText = "Score à battre: " + workoutData.bossTarget;
                
                // Set Boss Image for Workout Screen (btb1, btb2, etc)
                document.getElementById('boss-img-preview').src = workoutData.bossImg;
                training.currentBossId = workoutData.bossId;

                nav.to('screen-workout');
            },

            validateSession: () => {
                const score = parseInt(document.getElementById('workout-score').value) || 0;
                const dayKey = 'day' + training.selectedDay;
                const prevRecord = data.records[dayKey] || 0;
                const bossTarget = 100; // Placeholder
                
                const bossBadgeName = "boss" + training.currentBossId;

                let msg = "Séance validée.";

                if(score > prevRecord && prevRecord > 0) {
                    msg += "\nRECORD BATTU ! (+1 Trophée)";
                }
                data.records[dayKey] = score;

                if(score > bossTarget) {
                    msg += "\nBOSS BATTU !";
                    if(!data.bossBeaten[bossBadgeName]) data.bossBeaten[bossBadgeName] = 0;
                    data.bossBeaten[bossBadgeName]++;
                }

                data.sessions[dayKey] = { validated: true, score: score };
                db.save(data);
                alert(msg);
                training.init();
                nav.to('screen-training');
            }
        };

        // --- TROPHY GALLERY ---
        const gallery = {
            render: () => {
                document.getElementById('trophy-char-img').src = app.getCharImage(app.getGlobalLevel());
                const recordCount = Object.keys(data.records).length; 
                document.getElementById('total-records').innerText = recordCount;

                const bossContainer = document.getElementById('boss-trophy-container');
                bossContainer.innerHTML = '';
                
                // Check for boss1, boss2, boss3, boss4
                ['boss1','boss2','boss3','boss4'].forEach(bKey => {
                    if(data.bossBeaten[bKey] && data.bossBeaten[bKey] > 0) {
                         const div = document.createElement('div');
                        div.className = 'trophy-item';
                        div.innerHTML = `
                            <img src="${bKey}.png" onerror="this.src='https://via.placeholder.com/60?text=Win'">
                            <div>x${data.bossBeaten[bKey]}</div>
                        `;
                        div.onclick = () => alert("Tueur de Boss (Niveau " + bKey.replace('boss','') + ")");
                        bossContainer.appendChild(div);
                    }
                });

                const furyContainer = document.getElementById('fury-container');
                furyContainer.innerHTML = '';
                if(data.furyCount > 0) {
                    furyContainer.innerHTML = `
                        <div class="trophy-item">
                            <img src="fury.png" onerror="this.src='https://via.placeholder.com/60?text=Fury'">
                            <div>x${data.furyCount}</div>
                        </div>
                    `;
                }
            }
        };

        // --- NAVIGATION (CORRIGÉE) ---
        const nav = {
            to: (id) => {
                // 1. On cache tous les écrans
                document.querySelectorAll('.container').forEach(d => d.classList.add('hidden'));
                
                // 2. On affiche l'écran demandé
                document.getElementById(id).classList.remove('hidden');
                
                // 3. LOGIQUE D'INITIALISATION AUTOMATIQUE
                // Si on va au menu, on met à jour le perso
                if(id === 'screen-menu') app.updateCharacter();
                
                // Si on va au Training Camp, on construit la grille des jours !
                if(id === 'screen-training') training.init();
                
                // Si on va aux Trophées, on affiche les badges à jour
                if(id === 'screen-trophy') gallery.render();
            }
        };

        // --- INIT ---
        document.getElementById('screen-menu').classList.remove('hidden');
        app.updateCharacter();

        // Hook manuel pour le bouton trophée du menu (bien que géré par nav.to maintenant)
        // La fonction nav.to gère tout désormais.

    </script>
</body>
</html>
