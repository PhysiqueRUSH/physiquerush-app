<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PhysiqueRush - Massive Impact</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffeb3b">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --accent-pink: #ff6ec7;
            --accent-green: #4caf50;
            --accent-yellow: #ffeb3b;
            --accent-red: #f44336;
            --card-bg: #1e1e1e;
            --modal-bg: rgba(0, 0, 0, 0.85);
        }
        
        /* GENERAL */
        body { 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            color: var(--text-color); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            height: 100vh;
            overflow: hidden; 
            background: transparent;
        }

        #app-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: -2; }
        #lightning-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; overflow: hidden; }
        .lightning-flash { position: absolute; max-width: none; opacity: 0.8; pointer-events: none; }

        .container { 
            width: 95%; max-width: 500px; padding: 10px; text-align: center; 
            position: relative; z-index: 1; 
            display: flex; flex-direction: column; 
            height: 100%; 
            box-sizing: border-box; 
        }
        
        .hidden { display: none !important; }
        .scrollable-content { overflow-y: auto; display: block; height: 100%; padding-bottom: 20px; }

        /* --- STYLES MENU PRINCIPAL (FLEXBOX STRICT) --- */
        .menu-header {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-bottom: 5px;
        }

        .logo-reduced { width: 20%; max-width: 80px; margin-bottom: 5px; }
        .glow-effect { width: 100%; max-width: 250px; margin-bottom: 5px; animation: redPulse 2s infinite ease-in-out; }
        
        #char-display { margin: 0; }
        #char-img { 
            height: 18vh; 
            max-height: 180px;
            width: auto; 
            display: block; 
            margin: 0 auto; 
            object-fit: contain;
        }
        #global-level-badge { font-size: 1.1em; font-weight: bold; margin-top: 2px; color: var(--accent-yellow); text-shadow: 0 0 5px rgba(0,0,0,0.5); }

        /* Zone des Boutons */
        .menu-buttons-container {
            flex: 1; 
            display: flex;
            flex-direction: column;
            justify-content: space-evenly; 
            align-items: center;
            width: 100%;
            padding-bottom: 10px;
        }

        /* Images Boutons du Menu */
        .menu-btn-img {
            display: block;
            width: auto;
            max-width: 90%; 
            height: auto;
            max-height: 7vh; 
            cursor: pointer;
            transition: transform 0.1s;
            filter: drop-shadow(0 4px 3px rgba(0,0,0,0.6));
        }
        .menu-btn-img:active { transform: scale(0.95); filter: drop-shadow(0 2px 2px rgba(0,0,0,0.8)); }

        /* --- IMAGES TITRES (SOUS-ECRANS) --- */
        .screen-title {
            display: block;
            margin: 0 auto 15px auto;
            max-width: 90%; 
            height: auto;
            max-height: 70px;
            object-fit: contain;
        }
        
        /* Fallback si image manquante */
        .fallback-title {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--accent-yellow);
            text-transform: uppercase;
            margin-bottom: 20px;
            border: 2px solid var(--accent-yellow);
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
        }

        /* --- ELEMENTS UI STANDARD --- */
        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: var(--card-bg); color: white; border: 1px solid #333; cursor: pointer; text-align: center; font-weight: bold; text-transform: uppercase; border-radius: 8px; transition: 0.2s; }
        .btn:hover { background: #333; }
        .btn-red { background: var(--accent-red); color: black; border: none; }
        .btn-outline { background: transparent; border: 1px solid var(--accent-red); color: var(--accent-red); }
        .btn-danger-zone { margin-top: 30px; border: 1px solid var(--accent-red); color: var(--accent-red); opacity: 0.7; font-size: 0.8em; }

        .video-box { background: #000; height: 150px; display: flex; align-items: center; justify-content: center; margin: 0 0 20px 0; color: #555; border: 1px solid #333; font-size: 0.8em; width: 100%; }
        #radar-container { position: relative; width: 100%; height: 350px; margin: 0 auto 20px auto; background: #000; border-radius: 10px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; }
        canvas { max-width: 100%; max-height: 100%; }
        
        .week-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 8px; margin-bottom: 20px; justify-content: center; }
        .day-box { aspect-ratio: 1 / 1; background: #333; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.8em; border-radius: 8px; cursor: pointer; opacity: 0.6; transition: all 0.2s; border: 1px solid #444; }
        .day-box.active { border: 2px solid var(--accent-yellow); opacity: 1; background: #2a2a2a; box-shadow: 0 0 10px rgba(255, 235, 59, 0.2); }
        .day-box.done { background: var(--accent-green); color: black; opacity: 1; border: none; font-weight: bold; }
        
        .timer-overlay { background: #000; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; }
        .timer-digits { font-size: 3.5em; font-weight: bold; font-family: monospace; }
        .timer-state { font-size: 1.2em; color: var(--accent-pink); margin-bottom: 5px; min-height: 1.5em; }
        .timer-warning { animation: flashWarning 0.5s infinite; color: var(--accent-red) !important; }
        @keyframes flashWarning { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        @keyframes redPulse { 0% { box-shadow: 0 0 5px rgba(244, 67, 54, 0.3); } 50% { box-shadow: 0 0 25px rgba(244, 67, 54, 0.8), 0 0 10px rgba(244, 67, 54, 0.6); } 100% { box-shadow: 0 0 5px rgba(244, 67, 54, 0.3); } }

        input[type="number"] { width: 80px; padding: 10px; text-align: center; border-radius: 5px; border: none; font-size: 1.2em; background: #333; color: white; }
        .boss-section { border: 2px solid #444; padding: 15px; border-radius: 12px; margin-bottom: 20px; background: #151515; }
        #boss-img-preview { width: 225px; height: 225px; object-fit: contain; } 
        .trophy-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 20px; }
        .trophy-item { width: 130px; cursor: pointer; text-align: center; background: #1a1a1a; padding: 10px; border-radius: 10px; border: 1px solid #333; }
        .trophy-item img { width: 110px; height: 110px; object-fit: contain; display: block; margin: 0 auto; }
        .trophy-count { font-size: 1.4em; font-weight: bold; color: var(--accent-yellow); margin-top: 5px; display: block; }
        
        #custom-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--modal-bg); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1a1a1a; border: 2px solid #444; padding: 30px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.8); animation: modalPop 0.3s ease-out; }
        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-title { font-size: 1.5em; font-weight: bold; margin-bottom: 15px; color: var(--accent-yellow); text-transform: uppercase; }
        .modal-msg { font-size: 1.1em; margin-bottom: 25px; line-height: 1.5; }
        .modal-actions { display: flex; gap: 10px; justify-content: center; }
        .modal-btn { padding: 10px 20px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; text-transform: uppercase; }
        .btn-modal-confirm { background: var(--accent-green); color: black; }
        .btn-modal-cancel { background: #333; color: white; border: 1px solid #555; }
    </style>
</head>
<body>

    <div id="app-background"></div>
    <div id="lightning-container"></div>

    <div id="custom-modal" class="hidden">
        <div class="modal-content">
            <div id="modal-title" class="modal-title">TITRE</div>
            <div id="modal-msg" class="modal-msg">Message ici</div>
            <div id="modal-actions" class="modal-actions"></div>
        </div>
    </div>

    <div id="screen-menu" class="container">
        <div class="menu-header">
            <img src="physiquerush.png" class="logo-reduced" alt="Logo" onerror="this.style.display='none'">
            <img src="MIAH.png" class="glow-effect" alt="MIAH" onerror="this.style.display='none'">
            <div id="char-display">
                <img id="char-img" src="evo1.png" alt="Perso" onerror="this.src='https://via.placeholder.com/200x250?text=Perso'">
                <div id="global-level-badge">Niveau 0 / 40</div>
            </div>
        </div>

        <div class="menu-buttons-container">
            <img src="salledestests.png" class="menu-btn-img" onclick="nav.to('screen-levels')" alt="SALLE DES TESTS" onerror="this.outerHTML='<button class=\'btn\' onclick=\'nav.to(\'screen-levels\')\'>LEVELS ROOM</button>'">
            <img src="trainingarea.png" class="menu-btn-img" onclick="nav.to('screen-training')" alt="TRAINING AREA" onerror="this.outerHTML='<button class=\'btn\' onclick=\'nav.to(\'screen-training\')\'>TRAINING CAMP</button>'">
            <img src="nutrirush.png" class="menu-btn-img" onclick="ui.alert('Patience...', 'Le Module Nutri-Rush sera bientôt disponible !')" alt="NUTRI RUSH" onerror="this.outerHTML='<button class=\'btn\' onclick=\'ui.alert()\'>NUTRI RUSH</button>'">
            <img src="galerie.png" class="menu-btn-img" onclick="nav.to('screen-trophy')" alt="GALERIE" onerror="this.outerHTML='<button class=\'btn\' onclick=\'nav.to(\'screen-trophy\')\'>GALERIE</button>'">
            <img src="teamphysiquerush.png" class="menu-btn-img" onclick="window.location.href='https://wa.me/'" alt="TEAM WHATSAPP" onerror="this.outerHTML='<button class=\'btn\'>LA TEAM</button>'">
            <img src="quitterlejeu.png" class="menu-btn-img" onclick="window.close(); window.location.href='about:blank';" alt="QUITTER" onerror="this.outerHTML='<button class=\'btn btn-red\'>QUITTER</button>'">
        </div>
    </div>

    <div id="screen-levels" class="container hidden scrollable-content">
        <img src="salledestests.png" class="screen-title" alt="SALLE DES TESTS" onerror="this.outerHTML='<h2 class=\'fallback-title\'>LEVELS ROOM</h2>'">
        
        <button class="btn" onclick="evoLab.init()">Evolution Lab</button>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn" onclick="tests.start('Pectoraux')">Test Pecs</button>
            <button class="btn" onclick="tests.start('Jambes')">Test Jambes</button>
            <button class="btn" onclick="tests.start('Dos')">Test Dos</button>
            <button class="btn" onclick="tests.start('Triceps')">Test Triceps</button>
            <button class="btn" onclick="tests.start('Biceps')">Test Biceps</button>
        </div>
        <button class="btn" onclick="nav.to('screen-menu')" style="margin-top:20px;">Retour</button>
    </div>

    <div id="screen-evolab" class="container hidden scrollable-content">
        <h3>Evolution Lab</h3>
        <div id="radar-container">
            <canvas id="radarChart"></canvas>
        </div>
        <div id="evolab-global" style="font-size: 1.2em; color: var(--accent-yellow); font-weight: bold; margin-bottom: 15px;"></div>
        <button class="btn" onclick="nav.to('screen-levels')">Retour</button>
        <button class="btn btn-danger-zone" onclick="evoLab.resetTests()">⚠️ RÉINITIALISER MES TESTS</button>
    </div>

    <div id="screen-test" class="container hidden scrollable-content">
        <h2 id="test-name">Test</h2>
        <div class="video-box">[VIDEO VIMEO PLACEHOLDER]</div>
        <div class="timer-overlay">
            <div id="test-instruction-state" class="timer-state">Prêt ?</div>
            <div id="timer-display" class="timer-digits">08:00</div>
            <div id="current-palier" style="margin-top: 10px; font-size: 1.2em; color:#888;">Palier 1</div>
        </div>
        <h3 id="test-exercise-name" style="color: var(--accent-pink);">Exercice</h3>
        <div id="reps-target" style="color: var(--accent-yellow); font-size: 1.4em; margin-bottom: 20px;">Objectif: 10 reps</div>
        <button id="btn-start-test" class="btn btn-red" onclick="tests.run()" style="font-weight:900;">LANCER LE TEST</button>
        <button id="btn-fail-test" class="btn hidden" onclick="tests.fail()">J'ai échoué / Fin</button>
        <button class="btn" onclick="tests.quit()">Retour</button>
    </div>

    <div id="screen-training" class="container hidden scrollable-content">
        <img src="trainingarea.png" class="screen-title" alt="TRAINING AREA" onerror="this.outerHTML='<h2 class=\'fallback-title\'>TRAINING CAMP</h2>'">
        
        <div class="week-grid" id="week-grid"></div>
        <div id="training-info" style="margin-top: 20px; color: #888;">
            Sélectionnez votre séance du jour.
        </div>
        <button class="btn" onclick="nav.to('screen-menu')" style="margin-top: 30px;">Retour</button>
    </div>

    <div id="screen-workout" class="container hidden scrollable-content">
        <h2 id="workout-day-title">Jour X</h2>
        <div class="video-box">[VIDEO VIMEO SEANCE]</div>
        <div id="workout-chrono-panel" class="timer-overlay hidden">
            <div id="workout-timer-state" class="timer-state">Exercice 1/4</div>
            <div id="workout-timer-digits" class="timer-digits">00:00</div>
            <button class="btn btn-outline" onclick="training.stopTimer()" style="margin-top:10px; padding:5px;">Arrêter Chrono</button>
        </div>
        <button id="btn-start-workout-timer" class="btn" onclick="training.startSmartTimer()">⏱️ LANCER CHRONO SÉANCE</button>
        <div id="workout-list" style="text-align: left; margin-bottom: 20px; line-height: 1.6; font-size: 0.95em;"></div>
        <div class="boss-section">
            <h4 style="margin-top:0; color: var(--accent-red);">Beat The Boss</h4>
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;">
                <img id="boss-img-preview" src="" onerror="this.src='https://via.placeholder.com/225?text=BTB'">
                <span id="boss-score-target" style="font-size: 1.2em; font-weight: bold; color: white;">Score à battre: ???</span>
            </div>
        </div>
        <div id="validation-zone">
            <input type="number" id="workout-score" placeholder="Score">
            <button class="btn btn-red" onclick="training.validateSession()">VALIDER LA SEANCE</button>
        </div>
        <button id="btn-cancel-session" class="btn hidden" style="background: #333; color: #f44336; border: 1px solid #f44336;" onclick="training.cancelSession()">ANNULER / INVALIDER</button>
        <button class="btn" onclick="training.quit()">Retour</button>
    </div>

    <div id="screen-trophy" class="container hidden scrollable-content">
        <img src="galerie.png" class="screen-title" alt="GALERIE" onerror="this.outerHTML='<h2 class=\'fallback-title\'>GALERIE TROPHEES</h2>'">
        
        <div style="margin-bottom: 30px; background: #1a1a1a; padding: 20px; border-radius: 15px;">
            <img id="trophy-char-img" src="" style="width: 200px; margin: 0 auto; display: block;">
            <div id="trophy-next-evo" style="color: #aaa; font-size: 0.9em; margin-top: 10px; font-style: italic;"></div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 15px;">
                <img src="record.png" onerror="this.src='https://via.placeholder.com/80?text=Rec'" style="width: 80px; height: 80px; object-fit: contain;">
                <span id="total-records" style="font-size: 2.5em; font-weight: bold; color: var(--accent-yellow);">0</span>
            </div>
            <div style="font-size: 0.9em; color: #888; margin-top: 5px;">Records battus</div>
        </div>
        <h3 style="border-bottom: 1px solid #333; padding-bottom: 10px;">Boss Vaincus</h3>
        <div id="boss-trophy-container" class="trophy-grid"></div>
        <h3 style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 30px;">Mode Fury</h3>
        <div id="fury-container" class="trophy-grid"></div>
        <button class="btn" style="margin-top: 30px;" onclick="nav.to('screen-menu')">Retour</button>
        <button class="btn btn-danger-zone" onclick="gallery.resetTrophies()">⚠️ EFFACER TOUTES LES RÉCOMPENSES</button>
    </div>

    <script>
        // --- UI MANAGER ---
        const ui = {
            modal: document.getElementById('custom-modal'),
            title: document.getElementById('modal-title'),
            msg: document.getElementById('modal-msg'),
            actions: document.getElementById('modal-actions'),
            show: (title, message, buttons = []) => {
                ui.title.innerText = title;
                ui.msg.innerHTML = message;
                ui.actions.innerHTML = '';
                buttons.forEach(btn => {
                    const b = document.createElement('button');
                    b.className = 'modal-btn ' + (btn.class || '');
                    b.innerText = btn.text;
                    b.onclick = () => { ui.hide(); if(btn.onClick) btn.onClick(); };
                    ui.actions.appendChild(b);
                });
                ui.modal.classList.remove('hidden');
            },
            hide: () => { ui.modal.classList.add('hidden'); },
            alert: (title, message, callback) => {
                ui.show(title, message, [{ text: 'OK', class: 'btn-modal-confirm', onClick: callback }]);
            },
            confirm: (title, message, onConfirm) => {
                ui.show(title, message, [
                    { text: 'Annuler', class: 'btn-modal-cancel' },
                    { text: 'Confirmer', class: 'btn-modal-confirm', onClick: onConfirm }
                ]);
            },
            showResult: (score, callback) => {
                let rank = "DÉBUTANT";
                let color = "#ff6ec7";
                if(score >= 3) { rank = "INTERMÉDIAIRE"; color = "#4caf50"; }
                if(score >= 5) { rank = "AVANCÉ"; color = "#ffeb3b"; }
                if(score >= 7) { rank = "EXPERT"; color = "#f44336"; }
                const html = `<div style="font-size:3em; font-weight:bold; margin-bottom:10px;">${score}</div><div style="font-size:1.5em; font-weight:bold; color:${color}; border:2px solid ${color}; padding:10px; border-radius:10px; display:inline-block;">${rank}</div><div style="margin-top:15px; font-style:italic;">Palier validé</div>`;
                ui.show("RÉSULTAT DU TEST", html, [{ text: 'CONTINUER', class: 'btn-modal-confirm', onClick: callback }]);
            }
        };

        // --- AUDIO ---
        const audio = {
            ctx: null,
            init: () => { if (!audio.ctx) audio.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
            beep: (type) => { 
                audio.init();
                const osc = audio.ctx.createOscillator();
                const gain = audio.ctx.createGain();
                osc.connect(gain);
                gain.connect(audio.ctx.destination);
                osc.type = 'sine';
                if (type === 'long') {
                    osc.frequency.setValueAtTime(600, audio.ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(300, audio.ctx.currentTime + 0.5);
                    gain.gain.setValueAtTime(0.5, audio.ctx.currentTime);
                    osc.start();
                    osc.stop(audio.ctx.currentTime + 0.6);
                } else { 
                    osc.frequency.value = 880;
                    gain.gain.setValueAtTime(0.1, audio.ctx.currentTime);
                    osc.start();
                    osc.stop(audio.ctx.currentTime + 0.1);
                }
            }
        };

        // --- BACKGROUND FX ---
        const lightning = {
            container: document.getElementById('lightning-container'),
            images: ['eclair1.png', 'eclair2.png', 'eclair3.png'],
            init: () => { lightning.schedule(); },
            schedule: () => {
                const delay = Math.random() * (5000 - 300) + 300;
                setTimeout(() => { lightning.flash(); lightning.schedule(); }, delay);
            },
            flash: () => {
                const imgName = lightning.images[Math.floor(Math.random() * lightning.images.length)];
                const img = document.createElement('img');
                img.src = imgName;
                img.className = 'lightning-flash';
                if (imgName === 'eclair1.png') {
                    img.style.left = '0px';
                    img.style.top = (Math.random() * 80) + '%';
                } else {
                    img.style.top = '0px';
                    img.style.left = (Math.random() * 80) + '%'; 
                }
                lightning.container.appendChild(img);
                setTimeout(() => { img.remove(); }, 150);
            }
        };

        // --- DATA ---
        const db = {
            load: () => JSON.parse(localStorage.getItem('physiqueRushDB')) || db.default(),
            save: (data) => localStorage.setItem('physiqueRushDB', JSON.stringify(data)),
            default: () => ({
                stats: { Pectoraux: 0, Jambes: 0, Dos: 0, Triceps: 0, Biceps: 0 }, 
                history: { originalStats: { Pectoraux: 0, Jambes: 0, Dos: 0, Triceps: 0, Biceps: 0 } },
                sessions: {}, records: {}, bossBeaten: {}, furyCount: 0
            })
        };
        let data = db.load();

        // --- LOGIC ---
        const app = {
            getGlobalLevel: () => {
                let sum = 0;
                for(let k in data.stats) sum += data.stats[k];
                return sum;
            },
            getFunctionalLevel: (muscle) => {
                const val = data.stats[muscle];
                return val === 0 ? 1 : val;
            },
            getCharImage: (level) => {
                if(level < 5) return 'evo1.png';
                if(level <= 10) return 'evo1.png';
                if(level <= 15) return 'evo2.png';
                if(level <= 19) return 'evo3.png';
                if(level <= 23) return 'evo4.png';
                if(level <= 26) return 'evo5.png';
                if(level <= 29) return 'evo6.png';
                if(level <= 32) return 'evo7.png';
                if(level <= 34) return 'evo8.png';
                if(level <= 36) return 'evo9.png';
                if(level <= 38) return 'evo10.png';
                if(level === 39) return 'evo11.png';
                return 'evo12.png';
            },
            updateCharacter: () => {
                const lvl = app.getGlobalLevel();
                const imgName = app.getCharImage(lvl);
                document.getElementById('char-img').src = imgName; 
                document.getElementById('global-level-badge').innerText = "Niveau " + lvl + " / 40";
            },
            getLevelColor: (val) => {
                if(val <= 2) return '#ff6ec7'; 
                if(val <= 4) return '#4caf50'; 
                if(val <= 6) return '#ffeb3b'; 
                return '#f44336'; 
            }
        };

        // --- TESTS ---
        const tests = {
            currentTest: null,
            timer: null,
            interval: null,
            config: {
                'Pectoraux': 'Pompes Dead-Stop',
                'Jambes': 'Fentes Sautées',
                'Dos': 'Rowing Corner Coudes Écartés',
                'Triceps': 'Dips Chaise Jambes Tendues',
                'Biceps': 'Drag Curl au Sol'
            },
            start: (muscle) => {
                tests.currentTest = muscle;
                document.getElementById('test-name').innerText = "Test " + muscle;
                document.getElementById('test-exercise-name').innerText = tests.config[muscle];
                document.getElementById('timer-display').innerText = "08:00";
                document.getElementById('test-instruction-state').innerText = "Prêt ?";
                document.getElementById('test-instruction-state').classList.remove('timer-warning');
                document.getElementById('reps-target').innerText = "Objectif: 10 reps";
                document.getElementById('current-palier').innerText = "Palier 1";
                document.getElementById('btn-start-test').classList.remove('hidden');
                document.getElementById('btn-fail-test').classList.add('hidden');
                nav.to('screen-test');
            },
            run: () => {
                audio.init(); 
                document.getElementById('btn-start-test').classList.add('hidden');
                document.getElementById('btn-fail-test').classList.remove('hidden');
                
                let totalSeconds = 8 * 60;
                let secondsInMinute = 60;
                let palier = 1;
                let reps = 10;
                audio.beep('long'); 

                tests.interval = setInterval(() => {
                    totalSeconds--;
                    secondsInMinute--;

                    let min = Math.floor(totalSeconds / 60);
                    let sec = totalSeconds % 60;
                    document.getElementById('timer-display').innerText = `0${min}:${sec < 10 ? '0'+sec : sec}`;

                    const stateDiv = document.getElementById('test-instruction-state');
                    if(secondsInMinute <= 10 && secondsInMinute > 0) {
                        stateDiv.innerText = "PRÉPAREZ-VOUS !";
                        stateDiv.classList.add('timer-warning');
                        audio.beep('short'); 
                    } else {
                        stateDiv.classList.remove('timer-warning');
                        stateDiv.innerText = "En cours...";
                    }

                    if (secondsInMinute <= 0) {
                        if (totalSeconds <= 0) {
                            tests.finish(8); 
                            return;
                        }
                        audio.beep('long');
                        palier++;
                        reps += 2;
                        secondsInMinute = 60;
                        document.getElementById('current-palier').innerText = "Palier " + palier;
                        document.getElementById('reps-target').innerText = "Objectif: " + reps + " reps";
                        stateDiv.innerText = "GO !";
                    }
                }, 1000); 
            },
            fail: () => {
                let currentP = parseInt(document.getElementById('current-palier').innerText.split(' ')[1]);
                let validated = currentP > 1 ? currentP - 1 : 0; 
                tests.finish(validated);
            },
            finish: (score) => {
                clearInterval(tests.interval);
                data.stats[tests.currentTest] = score;
                db.save(data);
                ui.showResult(score, () => nav.to('screen-levels'));
            },
            quit: () => {
                clearInterval(tests.interval);
                nav.to('screen-levels');
            }
        };

        // --- EVOLUTION LAB ---
        const evoLab = {
            chart: null,
            init: () => {
                nav.to('screen-evolab');
                evoLab.render(data.stats);
                document.getElementById('evolab-global').innerText = "Niveau Global: " + app.getGlobalLevel() + " / 40";
            },
            render: (statsObj) => {
                const ctx = document.getElementById('radarChart').getContext('2d');
                const values = [statsObj.Pectoraux, statsObj.Jambes, statsObj.Dos, statsObj.Triceps, statsObj.Biceps];
                const displayValues = values.map(v => v === 0 ? 1 : v);
                const pointColors = displayValues.map(v => app.getLevelColor(v));

                if(evoLab.chart) evoLab.chart.destroy();

                evoLab.chart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['Pectoraux', 'Jambes', 'Dos', 'Triceps', 'Biceps'],
                        datasets: [{
                            data: displayValues,
                            backgroundColor: 'rgba(255, 235, 59, 0.2)',
                            borderColor: '#fff',
                            borderWidth: 1,
                            pointBackgroundColor: pointColors,
                            pointBorderColor: '#fff',
                            pointRadius: 6 
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                min: 0, max: 8,
                                ticks: { stepSize: 1, display: false },
                                grid: { color: '#444' },
                                pointLabels: { color: '#fff', font: {size: 11, weight:'bold'} },
                                angleLines: { color: '#444' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            },
            resetTests: () => {
                ui.confirm("RÉINITIALISATION", "Voulez-vous vraiment effacer tous vos résultats de tests ? Votre niveau global reviendra à 0.", () => {
                    data.stats = { Pectoraux: 0, Jambes: 0, Dos: 0, Triceps: 0, Biceps: 0 };
                    db.save(data);
                    evoLab.init(); 
                    app.updateCharacter(); 
                    ui.alert("TERMINE", "Données réinitialisées.");
                });
            }
        };

        // --- TRAINING CAMP ---
        const training = {
            timerInterval: null,
            days: [
                { id: 1, name: 'Pectoraux' }, { id: 2, name: 'Jambes (Poly)' },
                { id: 3, name: 'Dos' }, { id: 4, name: 'Tri/Bi' },
                { id: 5, name: 'Pectoraux' }, { id: 6, name: 'Jambes (Iso)' },
                { id: 7, name: 'Dos' }
            ],
            getDifficultyIndex: (lvl) => {
                if(lvl<=2) return 1; if(lvl<=4) return 2; if(lvl<=6) return 3; return 4;            
            },
            getWorkoutDetails: (dayId) => {
                const getLvl = (m) => app.getFunctionalLevel(m); 
                const getCatCode = (lvl) => {
                    const idx = training.getDifficultyIndex(lvl);
                    return idx === 1 ? 'beg' : idx === 2 ? 'int' : idx === 3 ? 'adv' : 'exp';
                };
                let content = "";
                let structure = []; 
                let primaryMuscleLvl = 1;

                if(dayId === 1 || dayId === 5) { 
                    primaryMuscleLvl = getLvl('Pectoraux');
                    structure = [120, 120, 120, 120];
                    const lvl = getCatCode(primaryMuscleLvl);
                    if(lvl === 'beg') content = "2' Pompes Excentrique > 2' Pompes Genoux Partielles > 2' Pompes Genoux Excentriques > 2' Pompes Corner";
                    if(lvl === 'int') content = "Pompes Dead-Stop > Pompes Jambe Traversante > Pompes Excentriques > Pompes Genoux Partielles";
                    if(lvl === 'adv') content = "Pompes Décalage Pliométriques > Pompes Horloge > Pompes Dead-Stop > Pompes Jambe Traversante";
                    if(lvl === 'exp') content = "Pompes Archer Unilatérales > Pompes Diamant > Pompes Décalage Pliométriques > Pompes Horloge";
                }
                else if(dayId === 2) { 
                    primaryMuscleLvl = getLvl('Jambes');
                    const idx = training.getDifficultyIndex(primaryMuscleLvl);
                    if(idx <= 2) { 
                        structure = [240, 240];
                        if(idx===1) content = "4' Fentes Arrières Basses > 4' Frog Jumps";
                        else content = "4' Fentes Sautées > 4' Fentes Arrières Basses";
                    } else { 
                        structure = [480];
                        if(idx===3) content = "8' Single Leg Landmines";
                        else content = "8' Levitation Squat Unilateral";
                    }
                }
                else if(dayId === 3 || dayId === 7) { 
                    primaryMuscleLvl = getLvl('Dos');
                    structure = [120, 120, 120, 120];
                    const lvl = getCatCode(primaryMuscleLvl);
                    let rowName = (dayId === 7) ? "RC" : "Rowing Corner";
                    if(lvl === 'beg') content = `${rowName} Coudes Écartés > Chandelier > Superman Row Supination > Snow Angels`;
                    if(lvl === 'int') content = `${rowName} Coudes Tendus > ${rowName} Coudes Écartés > Chandelier > Superman Row Supination`;
                    if(lvl === 'adv') content = `${rowName} Champion > ${rowName} Coudes Tendus > ${rowName} Coudes Écartés > Chandelier`;
                    if(lvl === 'exp') content = `${rowName} Coudes Serrés > ${rowName} Champion > ${rowName} Coudes Tendus > ${rowName} Coudes Écartés`;
                }
                else if(dayId === 4) { 
                    primaryMuscleLvl = getLvl('Triceps'); 
                    structure = [240, 240];
                    const lTri = getCatCode(primaryMuscleLvl);
                    const lBi = getCatCode(getLvl('Biceps'));
                    let triEx="", biEx=""; 
                    if(lTri === 'beg') triEx = "Wall Triceps Extension"; else if(lTri === 'int') triEx = "Pompes du Sphinx"; else if(lTri === 'adv') triEx = "Pompes Tigre Genoux"; else triEx = "Pompes Tigre";
                    if(lBi === 'beg') biEx = "Sock Drag Curl"; else if(lBi === 'int') biEx = "Corner Curl Unilatéral"; else if(lBi === 'adv') biEx = "Drag Curl au sol"; else biEx = "Rotation Drag Curl Unilatéral";
                    content = `Triceps (4'): ${triEx} <br><br> Biceps (4'): ${biEx}`;
                }
                else if(dayId === 6) { 
                    primaryMuscleLvl = getLvl('Jambes');
                    structure = [240, 240];
                    const lvl = getCatCode(primaryMuscleLvl);
                    if(lvl === 'beg') content = "4' Leg Extension de l'Ours > 4' Pont Piétinement";
                    if(lvl === 'int') content = "4' Corner Sissy Squat > 4' Leg Curl Glissé Alterné";
                    if(lvl === 'adv') content = "4' Sissy Squat > 4' Leg Curl Glissé";
                    if(lvl === 'exp') content = "4' Sissy Squat Partiel Bas > 4' Leg Curl Glissé Unilatéral";
                }

                const diffIdx = training.getDifficultyIndex(primaryMuscleLvl);
                const bossImg = `btb${diffIdx}.png`;

                return { desc: content, bossTarget: 100, bossImg: bossImg, bossId: diffIdx, timeStructure: structure };
            },
            selectedDay: null,
            currentBossId: null,
            currentTimeStructure: [],
            init: () => {
                const grid = document.getElementById('week-grid');
                grid.innerHTML = '';
                training.days.forEach(d => {
                    const el = document.createElement('div');
                    el.className = 'day-box';
                    el.innerHTML = `<span style="font-size:1.5em; font-weight:bold;">J${d.id}</span><span>${d.name}</span>`;
                    
                    if(data.sessions['day'+d.id]) {
                        el.classList.add('done');
                        el.innerHTML += "<span>✔</span>";
                    }
                    el.onclick = () => training.openDay(d.id);
                    grid.appendChild(el);
                });
            },
            openDay: (dayId) => {
                training.selectedDay = dayId;
                const wk = training.getWorkoutDetails(dayId);
                training.currentTimeStructure = wk.timeStructure;
                
                document.getElementById('workout-day-title').innerText = `Jour ${dayId}: ${training.days[dayId-1].name}`;
                document.getElementById('workout-list').innerHTML = wk.desc;
                document.getElementById('boss-score-target').innerText = "Score à battre: " + wk.bossTarget;
                document.getElementById('boss-img-preview').src = wk.bossImg;
                training.currentBossId = wk.bossId;

                if(data.sessions['day'+dayId]) {
                    document.getElementById('validation-zone').classList.add('hidden');
                    document.getElementById('btn-cancel-session').classList.remove('hidden');
                    document.getElementById('workout-score').value = data.sessions['day'+dayId].score;
                } else {
                    document.getElementById('validation-zone').classList.remove('hidden');
                    document.getElementById('btn-cancel-session').classList.add('hidden');
                    document.getElementById('workout-score').value = "";
                }
                document.getElementById('workout-chrono-panel').classList.add('hidden');
                document.getElementById('btn-start-workout-timer').classList.remove('hidden');

                nav.to('screen-workout');
            },
            startSmartTimer: () => {
                audio.init();
                document.getElementById('btn-start-workout-timer').classList.add('hidden');
                document.getElementById('workout-chrono-panel').classList.remove('hidden');
                
                let segmentIndex = 0;
                let timeLeft = training.currentTimeStructure[segmentIndex];
                const totalSegments = training.currentTimeStructure.length;
                
                const updateDisplay = () => {
                    let min = Math.floor(timeLeft / 60);
                    let sec = timeLeft % 60;
                    document.getElementById('workout-timer-digits').innerText = `0${min}:${sec < 10 ? '0'+sec : sec}`;
                    document.getElementById('workout-timer-state').innerText = `Exercice ${segmentIndex + 1} / ${totalSegments}`;
                };

                audio.beep('long'); 
                updateDisplay();

                training.timerInterval = setInterval(() => {
                    timeLeft--;
                    updateDisplay();
                    if(timeLeft <= 3 && timeLeft > 0) audio.beep('short');

                    if(timeLeft <= 0) {
                        segmentIndex++;
                        if(segmentIndex < totalSegments) {
                            audio.beep('long');
                            timeLeft = training.currentTimeStructure[segmentIndex];
                            updateDisplay();
                        } else {
                            audio.beep('long');
                            clearInterval(training.timerInterval);
                            document.getElementById('workout-timer-state').innerText = "TERMINÉ !";
                            document.getElementById('workout-timer-digits').innerText = "00:00";
                            setTimeout(() => {
                                document.getElementById('workout-chrono-panel').classList.add('hidden');
                                document.getElementById('btn-start-workout-timer').classList.remove('hidden');
                            }, 3000);
                        }
                    }
                }, 1000);
            },
            stopTimer: () => {
                clearInterval(training.timerInterval);
                document.getElementById('workout-chrono-panel').classList.add('hidden');
                document.getElementById('btn-start-workout-timer').classList.remove('hidden');
            },
            validateSession: () => {
                const score = parseInt(document.getElementById('workout-score').value) || 0;
                const dayKey = 'day' + training.selectedDay;
                const prevRecord = data.records[dayKey] || 0;
                const bossTarget = 100; 
                const bossBadgeName = "boss" + training.currentBossId;

                let gainedBoss = false;
                let msg = "Séance validée.";

                if(score > prevRecord && prevRecord > 0) {
                    msg += "<br>RECORD BATTU !";
                }
                data.records[dayKey] = score;

                if(score > bossTarget) {
                    msg += "<br>BOSS BATTU !";
                    if(!data.bossBeaten[bossBadgeName]) data.bossBeaten[bossBadgeName] = 0;
                    data.bossBeaten[bossBadgeName]++;
                    gainedBoss = true;
                }

                data.sessions[dayKey] = { 
                    validated: true, 
                    score: score, 
                    undoData: { gainedBoss: gainedBoss, bossName: bossBadgeName } 
                };
                
                db.save(data);
                ui.alert("FÉLICITATIONS", msg, () => {
                    training.init();
                    nav.to('screen-training');
                });
            },
            cancelSession: () => {
                ui.confirm("ANNULATION", "Voulez-vous vraiment annuler cette séance ? Cela effacera le statut validé et les récompenses associées.", () => {
                    const dayKey = 'day' + training.selectedDay;
                    const session = data.sessions[dayKey];
                    
                    if(session && session.undoData) {
                        if(session.undoData.gainedBoss) {
                            const bName = session.undoData.bossName;
                            if(data.bossBeaten[bName] > 0) data.bossBeaten[bName]--;
                        }
                    }
                    
                    delete data.sessions[dayKey];
                    db.save(data);
                    ui.alert("INFO", "Séance annulée.", () => {
                        training.init();
                        nav.to('screen-training');
                    });
                });
            },
            quit: () => {
                training.stopTimer();
                nav.to('screen-training');
            }
        };

        // --- TROPHY GALLERY ---
        const gallery = {
            render: () => {
                document.getElementById('trophy-char-img').src = app.getCharImage(app.getGlobalLevel());
                const recordCount = Object.keys(data.records).length; 
                document.getElementById('total-records').innerText = recordCount;

                const lvl = app.getGlobalLevel();
                const thresholds = [10, 15, 19, 23, 26, 29, 32, 34, 36, 38, 39, 40];
                let next = thresholds.find(t => t > lvl);
                let evoText = "";
                
                if(next) {
                    let diff = next - lvl;
                    evoText = `Plus que ${diff} niveau${diff > 1 ? 'x' : ''} avant évolution !`;
                } else if (lvl >= 40) {
                    evoText = "Niveau Maximum atteint !";
                } else {
                    evoText = "Continuez l'entraînement !";
                }
                document.getElementById('trophy-next-evo').innerText = evoText;

                const bossContainer = document.getElementById('boss-trophy-container');
                bossContainer.innerHTML = '';
                ['boss1','boss2','boss3','boss4'].forEach(bKey => {
                    if(data.bossBeaten[bKey] && data.bossBeaten[bKey] > 0) {
                         const div = document.createElement('div');
                        div.className = 'trophy-item';
                        div.innerHTML = `
                            <img src="${bKey}.png" onerror="this.src='https://via.placeholder.com/130?text=Win'">
                            <span class="trophy-count">x${data.bossBeaten[bKey]}</span>
                        `;
                        div.onclick = () => ui.alert("BADGE", "Tueur de Boss (Niveau " + bKey.replace('boss','') + ")");
                        bossContainer.appendChild(div);
                    }
                });

                const furyContainer = document.getElementById('fury-container');
                furyContainer.innerHTML = '';
                if(data.furyCount > 0) {
                    furyContainer.innerHTML = `
                        <div class="trophy-item">
                            <img src="fury.png" onerror="this.src='https://via.placeholder.com/130?text=Fury'">
                            <span class="trophy-count">x${data.furyCount}</span>
                        </div>
                    `;
                } else {
                    furyContainer.innerHTML = "<div style='color:#666; font-style:italic;'>Pas encore de mode Fury activé</div>";
                }
            },
            resetTrophies: () => {
                ui.confirm("RESET", "Voulez-vous vraiment effacer TOUTES vos récompenses (Boss vaincus, Records, Mode Fury) ?\nCela n'affectera pas votre niveau de tests.", () => {
                    data.bossBeaten = {};
                    data.records = {};
                    data.furyCount = 0;
                    db.save(data);
                    gallery.render();
                    ui.alert("TERMINE", "Toutes les récompenses ont été effacées.");
                });
            }
        };

        // --- NAVIGATION ---
        const nav = {
            to: (id) => {
                document.querySelectorAll('.container').forEach(d => d.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                if(id === 'screen-menu') app.updateCharacter();
                if(id === 'screen-training') training.init();
                if(id === 'screen-trophy') gallery.render();
            }
        };

        // --- INIT ---
        document.getElementById('screen-menu').classList.remove('hidden');
        app.updateCharacter();
        lightning.init(); 

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>
