<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhysiqueRush - Massive Impact</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffeb3b">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #ffffff;
            --accent-pink: #ff6ec7;
            --accent-green: #4caf50;
            --accent-yellow: #ffeb3b;
            --accent-red: #f44336;
            --card-bg: #1e1e1e;
        }
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding-bottom: 50px; }
        
        .hidden { display: none !important; }
        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: var(--card-bg); color: white; border: 1px solid #333; cursor: pointer; text-align: center; font-weight: bold; text-transform: uppercase; border-radius: 8px; transition: 0.2s; }
        .btn:hover { background: #333; }
        .btn-red { background: var(--accent-red); color: black; border: none; }
        .btn-outline { background: transparent; border: 1px solid var(--accent-red); color: var(--accent-red); }
        .container { width: 95%; max-width: 500px; padding: 20px; text-align: center; }
        
        /* IMAGES */
        .main-img { display: block; margin: 0 auto 15px auto; border-radius: 15px; }
        .logo-reduced { width: 40%; max-width: 150px; }
        .glow-effect { width: 100%; max-width: 100%; animation: redPulse 2s infinite ease-in-out; }
        @keyframes redPulse {
            0% { box-shadow: 0 0 5px rgba(244, 67, 54, 0.3); }
            50% { box-shadow: 0 0 25px rgba(244, 67, 54, 0.8), 0 0 10px rgba(244, 67, 54, 0.6); }
            100% { box-shadow: 0 0 5px rgba(244, 67, 54, 0.3); }
        }

        /* HEADER */
        #char-display { margin-bottom: 20px; margin-top: 10px; }
        #char-img { max-width: 250px; display: block; margin: 0 auto; transition: transform 0.3s; }
        #global-level-badge { font-size: 1.4em; font-weight: bold; margin-top: 10px; color: var(--accent-yellow); text-shadow: 0 0 5px rgba(0,0,0,0.5); }

        /* RADAR */
        #radar-container { 
            position: relative; 
            width: 100%; 
            height: 350px; 
            margin: 0 auto 20px auto; /* Centrage */
            background: #000; 
            border-radius: 10px; 
            border: 1px solid #333;
            display: flex; align-items: center; justify-content: center;
        }
        canvas { max-width: 100%; max-height: 100%; }

        /* TRAINING GRID (NEW DESIGN) */
        .week-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); 
            gap: 10px; 
            margin-bottom: 20px; 
            justify-content: center;
        }
        .day-box { 
            aspect-ratio: 1 / 1; /* Carré parfait */
            background: #333; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 0.9em; 
            border-radius: 8px; 
            cursor: pointer; 
            opacity: 0.6; 
            transition: all 0.2s;
            border: 1px solid #444;
        }
        .day-box:hover { transform: scale(1.05); opacity: 0.8; }
        .day-box.active { border: 2px solid var(--accent-yellow); opacity: 1; background: #2a2a2a; box-shadow: 0 0 10px rgba(255, 235, 59, 0.2); }
        .day-box.done { background: var(--accent-green); color: black; opacity: 1; border: none; font-weight: bold; }
        
        /* WORKOUT / TIMER UI */
        .timer-overlay {
            background: #000; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px;
            display: flex; flex-direction: column; align-items: center;
        }
        .timer-digits { font-size: 3.5em; font-weight: bold; font-family: monospace; }
        .timer-state { font-size: 1.2em; color: var(--accent-pink); margin-bottom: 5px; min-height: 1.5em; }
        .timer-warning { animation: flashWarning 1s infinite; color: var(--accent-red) !important; }
        @keyframes flashWarning { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* INPUTS & BOSS */
        input[type="number"] { width: 80px; padding: 10px; text-align: center; border-radius: 5px; border: none; font-size: 1.2em; background: #333; color: white; }
        
        .boss-section { border: 2px solid #444; padding: 15px; border-radius: 12px; margin-bottom: 20px; background: #151515; }
        #boss-img-preview { width: 150px; height: 150px; object-fit: contain; } /* Plus gros */

        /* TROPHY GALLERY */
        .trophy-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px; }
        .trophy-item { width: 150px; cursor: pointer; text-align: center; background: #1a1a1a; padding: 10px; border-radius: 10px; border: 1px solid #333; }
        .trophy-item img { width: 130px; height: 130px; object-fit: contain; display: block; margin: 0 auto; }
        .trophy-count { font-size: 1.4em; font-weight: bold; color: var(--accent-yellow); margin-top: 5px; display: block; }
        
        .whatsapp-icon { width: 24px; vertical-align: middle; margin-left: 10px; }
    </style>
</head>
<body>

    <div id="screen-menu" class="container">
        <img src="physiquerush.png" class="main-img logo-reduced" alt="Logo" onerror="this.style.display='none'">
        <img src="MIAH.png" class="main-img glow-effect" alt="MIAH" onerror="this.style.display='none'">
        <div id="char-display">
            <img id="char-img" src="evo1.png" alt="Perso" onerror="this.src='https://via.placeholder.com/250x300?text=Perso'">
            <div id="global-level-badge">Niveau 0 / 40</div>
        </div>
        <button class="btn" onclick="nav.to('screen-levels')">LEVELS ROOM</button>
        <button class="btn" onclick="nav.to('screen-training')">TRAINING CAMP</button>
        <button class="btn" onclick="alert('Module Nutri-Rush bientôt disponible.')">NUTRI-RUSH</button>
        <button class="btn" onclick="nav.to('screen-trophy')">Galerie des Trophées</button>
        <button class="btn" onclick="window.location.href='https://wa.me/'">La Team PhysiqueRush <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" class="whatsapp-icon"></button>
        <button class="btn btn-red" onclick="window.close(); window.location.href='about:blank';">Quitter</button>
    </div>

    <div id="screen-levels" class="container hidden">
        <h2>LEVELS ROOM</h2>
        <button class="btn" onclick="evoLab.init()">Evolution Lab</button>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn" onclick="tests.start('Pectoraux')">Test Pecs</button>
            <button class="btn" onclick="tests.start('Jambes')">Test Jambes</button>
            <button class="btn" onclick="tests.start('Dos')">Test Dos</button>
            <button class="btn" onclick="tests.start('Triceps')">Test Triceps</button>
            <button class="btn" onclick="tests.start('Biceps')">Test Biceps</button>
        </div>
        <button class="btn" onclick="nav.to('screen-menu')" style="margin-top:20px;">Retour</button>
    </div>

    <div id="screen-evolab" class="container hidden">
        <h3>Evolution Lab</h3>
        <div id="radar-container">
            <canvas id="radarChart"></canvas>
        </div>
        <div id="evolab-global" style="font-size: 1.2em; color: var(--accent-yellow); font-weight: bold; margin-bottom: 15px;"></div>
        <button class="btn" onclick="nav.to('screen-levels')">Retour</button>
    </div>

    <div id="screen-test" class="container hidden">
        <h2 id="test-name">Test</h2>
        <div class="timer-overlay">
            <div id="test-instruction-state" class="timer-state">Prêt ?</div>
            <div id="timer-display" class="timer-digits">08:00</div>
            <div id="current-palier" style="margin-top: 10px; font-size: 1.2em; color:#888;">Palier 1</div>
        </div>
        
        <h3 id="test-exercise-name" style="color: var(--accent-pink);">Exercice</h3>
        <div id="reps-target" style="color: var(--accent-yellow); font-size: 1.4em; margin-bottom: 20px;">Objectif: 10 reps</div>
        
        <button id="btn-start-test" class="btn btn-red" onclick="tests.run()">LANCER LE TEST (BIPS)</button>
        <button id="btn-fail-test" class="btn hidden" onclick="tests.fail()">J'ai échoué / Fin</button>
        <button class="btn" onclick="tests.quit()">Retour</button>
    </div>

    <div id="screen-training" class="container hidden">
        <h2 style="font-size: 2em; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 30px;">Training Camp</h2>
        <div class="week-grid" id="week-grid">
            </div>
        <div id="training-info" style="margin-top: 20px; color: #888;">
            Sélectionnez votre séance du jour.
        </div>
        <button class="btn" onclick="nav.to('screen-menu')" style="margin-top: 30px;">Retour</button>
    </div>

    <div id="screen-workout" class="container hidden">
        <h2 id="workout-day-title">Jour X</h2>
        
        <div id="workout-chrono-panel" class="timer-overlay hidden">
            <div id="workout-timer-state" class="timer-state">Exercice 1/4</div>
            <div id="workout-timer-digits" class="timer-digits">00:00</div>
            <button class="btn btn-outline" onclick="training.stopTimer()" style="margin-top:10px; padding:5px;">Arrêter Chrono</button>
        </div>
        <button id="btn-start-workout-timer" class="btn" onclick="training.startSmartTimer()">⏱️ LANCER CHRONO SÉANCE</button>

        <div style="background: #000; height: 100px; display: flex; align-items: center; justify-content: center; margin: 15px 0; color: #555; border: 1px solid #333; font-size:0.8em;">
            [VIDEO VIMEO SEANCE]
        </div>

        <div id="workout-list" style="text-align: left; margin-bottom: 20px; line-height: 1.6; font-size: 0.95em;"></div>
        
        <div class="boss-section">
            <h4 style="margin-top:0; color: var(--accent-red);">Beat The Boss</h4>
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;">
                <img id="boss-img-preview" src="" onerror="this.src='https://via.placeholder.com/150?text=BTB'">
                <span id="boss-score-target" style="font-size: 1.2em; font-weight: bold; color: white;">Score à battre: ???</span>
            </div>
        </div>

        <div id="validation-zone">
            <input type="number" id="workout-score" placeholder="Score">
            <button class="btn btn-red" onclick="training.validateSession()">VALIDER LA SEANCE</button>
        </div>
        <button id="btn-cancel-session" class="btn hidden" style="background: #333; color: #f44336; border: 1px solid #f44336;" onclick="training.cancelSession()">ANNULER / INVALIDER</button>

        <button class="btn" onclick="training.quit()">Retour</button>
    </div>

    <div id="screen-trophy" class="container hidden">
        <h2>Galerie des Trophées</h2>
        <div style="margin-bottom: 30px; background: #1a1a1a; padding: 20px; border-radius: 15px;">
            <img id="trophy-char-img" src="" style="width: 200px; margin: 0 auto; display: block;">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 15px;">
                <img src="record.png" onerror="this.src='https://via.placeholder.com/80?text=Rec'" style="width: 80px; height: 80px; object-fit: contain;">
                <span id="total-records" style="font-size: 2.5em; font-weight: bold; color: var(--accent-yellow);">0</span>
            </div>
            <div style="font-size: 0.9em; color: #888; margin-top: 5px;">Records battus</div>
        </div>
        
        <h3 style="border-bottom: 1px solid #333; padding-bottom: 10px;">Boss Vaincus</h3>
        <div id="boss-trophy-container" class="trophy-grid"></div>

        <h3 style="border-bottom: 1px solid #333; padding-bottom: 10px; margin-top: 30px;">Mode Fury</h3>
        <div id="fury-container" class="trophy-grid"></div>

        <button class="btn" style="margin-top: 30px;" onclick="nav.to('screen-menu')">Retour</button>
    </div>

    <script>
        // --- AUDIO ENGINE ---
        const audio = {
            ctx: null,
            init: () => {
                if (!audio.ctx) audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            beep: (type) => { // type: 'short' or 'long'
                audio.init();
                const osc = audio.ctx.createOscillator();
                const gain = audio.ctx.createGain();
                osc.connect(gain);
                gain.connect(audio.ctx.destination);
                
                osc.type = 'sine';
                if (type === 'long') {
                    osc.frequency.setValueAtTime(600, audio.ctx.currentTime);
                    osc.frequency.exponentialRampToValueAtTime(300, audio.ctx.currentTime + 0.5);
                    gain.gain.setValueAtTime(0.5, audio.ctx.currentTime);
                    osc.start();
                    osc.stop(audio.ctx.currentTime + 0.6);
                } else { // short
                    osc.frequency.value = 880;
                    gain.gain.setValueAtTime(0.1, audio.ctx.currentTime);
                    osc.start();
                    osc.stop(audio.ctx.currentTime + 0.1);
                }
            }
        };

        // --- DATA ---
        const db = {
            load: () => JSON.parse(localStorage.getItem('physiqueRushDB')) || db.default(),
            save: (data) => localStorage.setItem('physiqueRushDB', JSON.stringify(data)),
            default: () => ({
                stats: { Pectoraux: 0, Jambes: 0, Dos: 0, Triceps: 0, Biceps: 0 }, // 0 par défaut
                history: { originalStats: { Pectoraux: 0, Jambes: 0, Dos: 0, Triceps: 0, Biceps: 0 } },
                sessions: {}, // "day1": { validated: true, score: 50, undoData: {...} }
                records: {}, 
                bossBeaten: {}, 
                furyCount: 0
            })
        };

        let data = db.load();

        // --- CORE LOGIC ---
        const app = {
            getGlobalLevel: () => {
                let sum = 0;
                for(let k in data.stats) sum += data.stats[k];
                return sum;
            },
            // Pour l'affichage et l'entraînement, 0 vaut 1
            getFunctionalLevel: (muscle) => {
                const val = data.stats[muscle];
                return val === 0 ? 1 : val;
            },
            getCharImage: (level) => {
                if(level < 5) return 'evo1.png'; // Cas spécifique niveau < 5
                if(level <= 10) return 'evo1.png';
                if(level <= 15) return 'evo2.png';
                if(level <= 19) return 'evo3.png';
                if(level <= 23) return 'evo4.png';
                if(level <= 26) return 'evo5.png';
                if(level <= 29) return 'evo6.png';
                if(level <= 32) return 'evo7.png';
                if(level <= 34) return 'evo8.png';
                if(level <= 36) return 'evo9.png';
                if(level <= 38) return 'evo10.png';
                if(level === 39) return 'evo11.png';
                return 'evo12.png';
            },
            updateCharacter: () => {
                const lvl = app.getGlobalLevel();
                const imgName = app.getCharImage(lvl);
                document.getElementById('char-img').src = imgName; 
                document.getElementById('global-level-badge').innerText = "Niveau " + lvl + " / 40";
            },
            getLevelColor: (val) => {
                // val = functional level (min 1)
                if(val <= 2) return '#ff6ec7'; 
                if(val <= 4) return '#4caf50'; 
                if(val <= 6) return '#ffeb3b'; 
                return '#f44336'; 
            }
        };

        // --- LEVELS ROOM / TESTS ---
        const tests = {
            currentTest: null,
            timer: null,
            interval: null,
            
            config: {
                'Pectoraux': 'Pompes Dead-Stop',
                'Jambes': 'Fentes Sautées',
                'Dos': 'Rowing Corner Coudes Écartés',
                'Triceps': 'Dips Chaise Jambes Tendues',
                'Biceps': 'Drag Curl au Sol'
            },

            start: (muscle) => {
                tests.currentTest = muscle;
                document.getElementById('test-name').innerText = "Test " + muscle;
                document.getElementById('test-exercise-name').innerText = tests.config[muscle];
                document.getElementById('timer-display').innerText = "08:00";
                document.getElementById('test-instruction-state').innerText = "Prêt ?";
                document.getElementById('test-instruction-state').classList.remove('timer-warning');
                document.getElementById('reps-target').innerText = "Objectif: 10 reps";
                document.getElementById('current-palier').innerText = "Palier 1";
                document.getElementById('btn-start-test').classList.remove('hidden');
                document.getElementById('btn-fail-test').classList.add('hidden');
                nav.to('screen-test');
            },
            
            run: () => {
                audio.init(); // Débloquer l'audio
                document.getElementById('btn-start-test').classList.add('hidden');
                document.getElementById('btn-fail-test').classList.remove('hidden');
                
                let totalSeconds = 8 * 60;
                let secondsInMinute = 60;
                let palier = 1;
                let reps = 10;
                
                audio.beep('long'); // Start beep

                tests.interval = setInterval(() => {
                    totalSeconds--;
                    secondsInMinute--;

                    // Affichage
                    let min = Math.floor(totalSeconds / 60);
                    let sec = totalSeconds % 60;
                    document.getElementById('timer-display').innerText = `0${min}:${sec < 10 ? '0'+sec : sec}`;

                    // Alertes Visuelles/Sonores (5 dernières secondes)
                    const stateDiv = document.getElementById('test-instruction-state');
                    if(secondsInMinute <= 5 && secondsInMinute > 0) {
                        stateDiv.innerText = "PRÉPAREZ-VOUS !";
                        stateDiv.classList.add('timer-warning');
                        if(secondsInMinute <= 3) audio.beep('short');
                    } else {
                        stateDiv.classList.remove('timer-warning');
                        stateDiv.innerText = "En cours...";
                    }

                    // Changement de Palier
                    if (secondsInMinute <= 0) {
                        if (totalSeconds <= 0) {
                            tests.finish(8); 
                            return;
                        }
                        // Passage palier
                        audio.beep('long');
                        palier++;
                        reps += 2;
                        secondsInMinute = 60;
                        document.getElementById('current-palier').innerText = "Palier " + palier;
                        document.getElementById('reps-target').innerText = "Objectif: " + reps + " reps";
                        stateDiv.innerText = "GO !";
                    }
                }, 1000); 
            },

            fail: () => {
                // Le palier actuel est raté, on valide le précédent
                // Note : pour l'affichage temps réel on était à "Palier X". Si fail, score = X-1.
                // Exception : si fail au palier 1, score = 0 ? Non, instruction dit "Palier 1 et 2 = Débutant".
                // Si fail palier 1 => score 0. (Car 0 dans la DB = non classé/début).
                let currentP = parseInt(document.getElementById('current-palier').innerText.split(' ')[1]);
                let validated = currentP > 1 ? currentP - 1 : 0; // Si fail palier 1, on stocke 0
                tests.finish(validated);
            },

            finish: (score) => {
                clearInterval(tests.interval);
                data.stats[tests.currentTest] = score;
                db.save(data);
                alert(`Test terminé. Palier validé : ${score}`);
                nav.to('screen-levels');
            },

            quit: () => {
                clearInterval(tests.interval);
                nav.to('screen-levels');
            }
        };

        // --- EVOLUTION LAB ---
        const evoLab = {
            chart: null,
            init: () => {
                nav.to('screen-evolab');
                evoLab.render(data.stats);
                document.getElementById('evolab-global').innerText = "Niveau Global: " + app.getGlobalLevel() + " / 40";
            },
            render: (statsObj) => {
                const ctx = document.getElementById('radarChart').getContext('2d');
                // Mapping: si valeur 0 => afficher 1
                const values = [statsObj.Pectoraux, statsObj.Jambes, statsObj.Dos, statsObj.Triceps, statsObj.Biceps];
                const displayValues = values.map(v => v === 0 ? 1 : v);
                const pointColors = displayValues.map(v => app.getLevelColor(v));

                if(evoLab.chart) evoLab.chart.destroy();

                evoLab.chart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['Pectoraux', 'Jambes', 'Dos', 'Triceps', 'Biceps'],
                        datasets: [{
                            data: displayValues,
                            backgroundColor: 'rgba(255, 235, 59, 0.2)',
                            borderColor: '#fff',
                            borderWidth: 1,
                            pointBackgroundColor: pointColors,
                            pointBorderColor: '#fff',
                            pointRadius: 6 
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                min: 0, max: 8,
                                ticks: { stepSize: 1, display: false },
                                grid: { color: '#444' },
                                pointLabels: { color: '#fff', font: {size: 11, weight:'bold'} },
                                angleLines: { color: '#444' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        };

        // --- TRAINING CAMP ---
        const training = {
            timerInterval: null,
            days: [
                { id: 1, name: 'Pectoraux' }, { id: 2, name: 'Jambes (Poly)' },
                { id: 3, name: 'Dos' }, { id: 4, name: 'Tri/Bi' },
                { id: 5, name: 'Pectoraux' }, { id: 6, name: 'Jambes (Iso)' },
                { id: 7, name: 'Dos' }
            ],
            
            getDifficultyIndex: (lvl) => {
                if(lvl<=2) return 1; if(lvl<=4) return 2; if(lvl<=6) return 3; return 4;            
            },

            // Retourne les infos exos ET la structure temporelle pour le chrono
            getWorkoutDetails: (dayId) => {
                const getLvl = (m) => app.getFunctionalLevel(m); // Utilise functional level (1 min)
                const getCatCode = (lvl) => {
                    const idx = training.getDifficultyIndex(lvl);
                    return idx === 1 ? 'beg' : idx === 2 ? 'int' : idx === 3 ? 'adv' : 'exp';
                };

                let content = "";
                let structure = []; // en secondes [120, 120, 120, 120]
                let primaryMuscleLvl = 1;

                if(dayId === 1 || dayId === 5) { // PECS: 4 x 2min
                    primaryMuscleLvl = getLvl('Pectoraux');
                    structure = [120, 120, 120, 120];
                    const lvl = getCatCode(primaryMuscleLvl);
                    if(lvl === 'beg') content = "2' Pompes Excentrique > 2' Pompes Genoux Partielles > 2' Pompes Genoux Excentriques > 2' Pompes Corner";
                    if(lvl === 'int') content = "Pompes Dead-Stop > Pompes Jambe Traversante > Pompes Excentriques > Pompes Genoux Partielles";
                    if(lvl === 'adv') content = "Pompes Décalage Pliométriques > Pompes Horloge > Pompes Dead-Stop > Pompes Jambe Traversante";
                    if(lvl === 'exp') content = "Pompes Archer Unilatérales > Pompes Diamant > Pompes Décalage Pliométriques > Pompes Horloge";
                }
                else if(dayId === 2) { // JAMBES POLY
                    primaryMuscleLvl = getLvl('Jambes');
                    const idx = training.getDifficultyIndex(primaryMuscleLvl);
                    if(idx <= 2) { // Beg/Int: 4min + 4min
                        structure = [240, 240];
                        if(idx===1) content = "4' Fentes Arrières Basses > 4' Frog Jumps";
                        else content = "4' Fentes Sautées > 4' Fentes Arrières Basses";
                    } else { // Adv/Exp: 8min
                        structure = [480];
                        if(idx===3) content = "8' Single Leg Landmines";
                        else content = "8' Levitation Squat Unilateral";
                    }
                }
                else if(dayId === 3 || dayId === 7) { // DOS: 4 x 2min
                    primaryMuscleLvl = getLvl('Dos');
                    structure = [120, 120, 120, 120];
                    const lvl = getCatCode(primaryMuscleLvl);
                    let rowName = (dayId === 7) ? "RC" : "Rowing Corner";
                    if(lvl === 'beg') content = `${rowName} Coudes Écartés > Chandelier > Superman Row Supination > Snow Angels`;
                    if(lvl === 'int') content = `${rowName} Coudes Tendus > ${rowName} Coudes Écartés > Chandelier > Superman Row Supination`;
                    if(lvl === 'adv') content = `${rowName} Champion > ${rowName} Coudes Tendus > ${rowName} Coudes Écartés > Chandelier`;
                    if(lvl === 'exp') content = `${rowName} Coudes Serrés > ${rowName} Champion > ${rowName} Coudes Tendus > ${rowName} Coudes Écartés`;
                }
                else if(dayId === 4) { // TRI/BI: 4min + 4min
                    primaryMuscleLvl = getLvl('Triceps'); 
                    structure = [240, 240];
                    const lTri = getCatCode(primaryMuscleLvl);
                    const lBi = getCatCode(getLvl('Biceps'));
                    let triEx="", biEx=""; 
                    if(lTri === 'beg') triEx = "Wall Triceps Extension"; else if(lTri === 'int') triEx = "Pompes du Sphinx"; else if(lTri === 'adv') triEx = "Pompes Tigre Genoux"; else triEx = "Pompes Tigre";
                    if(lBi === 'beg') biEx = "Sock Drag Curl"; else if(lBi === 'int') biEx = "Corner Curl Unilatéral"; else if(lBi === 'adv') biEx = "Drag Curl au sol"; else biEx = "Rotation Drag Curl Unilatéral";
                    content = `Triceps (4'): ${triEx} <br><br> Biceps (4'): ${biEx}`;
                }
                else if(dayId === 6) { // JAMBES ISO: 4min + 4min
                    primaryMuscleLvl = getLvl('Jambes');
                    structure = [240, 240];
                    const lvl = getCatCode(primaryMuscleLvl);
                    if(lvl === 'beg') content = "4' Leg Extension de l'Ours > 4' Pont Piétinement";
                    if(lvl === 'int') content = "4' Corner Sissy Squat > 4' Leg Curl Glissé Alterné";
                    if(lvl === 'adv') content = "4' Sissy Squat > 4' Leg Curl Glissé";
                    if(lvl === 'exp') content = "4' Sissy Squat Partiel Bas > 4' Leg Curl Glissé Unilatéral";
                }

                const diffIdx = training.getDifficultyIndex(primaryMuscleLvl);
                const bossImg = `btb${diffIdx}.png`;

                return { desc: content, bossTarget: 100, bossImg: bossImg, bossId: diffIdx, timeStructure: structure };
            },

            selectedDay: null,
            currentBossId: null,
            currentTimeStructure: [],

            init: () => {
                const grid = document.getElementById('week-grid');
                grid.innerHTML = '';
                training.days.forEach(d => {
                    const el = document.createElement('div');
                    el.className = 'day-box';
                    el.innerHTML = `<span style="font-size:1.5em; font-weight:bold;">J${d.id}</span><span>${d.name}</span>`;
                    
                    if(data.sessions['day'+d.id]) {
                        el.classList.add('done');
                        el.innerHTML += "<span>✔</span>";
                    }
                    el.onclick = () => training.openDay(d.id);
                    grid.appendChild(el);
                });
            },

            openDay: (dayId) => {
                training.selectedDay = dayId;
                const wk = training.getWorkoutDetails(dayId);
                training.currentTimeStructure = wk.timeStructure;
                
                document.getElementById('workout-day-title').innerText = `Jour ${dayId}: ${training.days[dayId-1].name}`;
                document.getElementById('workout-list').innerHTML = wk.desc;
                document.getElementById('boss-score-target').innerText = "Score à battre: " + wk.bossTarget;
                document.getElementById('boss-img-preview').src = wk.bossImg;
                training.currentBossId = wk.bossId;

                // Gestion affichage validation vs annulation
                if(data.sessions['day'+dayId]) {
                    document.getElementById('validation-zone').classList.add('hidden');
                    document.getElementById('btn-cancel-session').classList.remove('hidden');
                    document.getElementById('workout-score').value = data.sessions['day'+dayId].score;
                } else {
                    document.getElementById('validation-zone').classList.remove('hidden');
                    document.getElementById('btn-cancel-session').classList.add('hidden');
                    document.getElementById('workout-score').value = "";
                }

                // Reset Timer UI
                document.getElementById('workout-chrono-panel').classList.add('hidden');
                document.getElementById('btn-start-workout-timer').classList.remove('hidden');

                nav.to('screen-workout');
            },

            // --- SMART TIMER ---
            startSmartTimer: () => {
                audio.init();
                document.getElementById('btn-start-workout-timer').classList.add('hidden');
                document.getElementById('workout-chrono-panel').classList.remove('hidden');
                
                let segmentIndex = 0;
                let timeLeft = training.currentTimeStructure[segmentIndex];
                const totalSegments = training.currentTimeStructure.length;
                
                const updateDisplay = () => {
                    let min = Math.floor(timeLeft / 60);
                    let sec = timeLeft % 60;
                    document.getElementById('workout-timer-digits').innerText = `0${min}:${sec < 10 ? '0'+sec : sec}`;
                    document.getElementById('workout-timer-state').innerText = `Exercice ${segmentIndex + 1} / ${totalSegments}`;
                };

                audio.beep('long'); // Start
                updateDisplay();

                training.timerInterval = setInterval(() => {
                    timeLeft--;
                    updateDisplay();
                    
                    // Alertes sonores fin d'exo
                    if(timeLeft <= 3 && timeLeft > 0) audio.beep('short');

                    if(timeLeft <= 0) {
                        segmentIndex++;
                        if(segmentIndex < totalSegments) {
                            // Next segment
                            audio.beep('long');
                            timeLeft = training.currentTimeStructure[segmentIndex];
                            updateDisplay();
                        } else {
                            // Finish
                            audio.beep('long');
                            clearInterval(training.timerInterval);
                            document.getElementById('workout-timer-state').innerText = "TERMINÉ !";
                            document.getElementById('workout-timer-digits').innerText = "00:00";
                            setTimeout(() => {
                                document.getElementById('workout-chrono-panel').classList.add('hidden');
                                document.getElementById('btn-start-workout-timer').classList.remove('hidden');
                            }, 3000);
                        }
                    }
                }, 1000);
            },

            stopTimer: () => {
                clearInterval(training.timerInterval);
                document.getElementById('workout-chrono-panel').classList.add('hidden');
                document.getElementById('btn-start-workout-timer').classList.remove('hidden');
            },

            validateSession: () => {
                const score = parseInt(document.getElementById('workout-score').value) || 0;
                const dayKey = 'day' + training.selectedDay;
                const prevRecord = data.records[dayKey] || 0;
                const bossTarget = 100; 
                const bossBadgeName = "boss" + training.currentBossId;

                let gainedTrophy = false;
                let gainedBoss = false;
                let msg = "Séance validée.";

                if(score > prevRecord && prevRecord > 0) {
                    msg += "\nRECORD BATTU !";
                    // Note: système trophées simplifié, on ne stocke pas un compteur de "Record" explicite
                    // sauf si on veut l'ajouter aux stats. Ici on laisse le score parler.
                }
                data.records[dayKey] = score;

                if(score > bossTarget) {
                    msg += "\nBOSS BATTU !";
                    if(!data.bossBeaten[bossBadgeName]) data.bossBeaten[bossBadgeName] = 0;
                    data.bossBeaten[bossBadgeName]++;
                    gainedBoss = true;
                }

                data.sessions[dayKey] = { 
                    validated: true, 
                    score: score, 
                    undoData: { gainedBoss: gainedBoss, bossName: bossBadgeName } 
                };
                
                db.save(data);
                alert(msg);
                training.init();
                nav.to('screen-training');
            },

            cancelSession: () => {
                if(!confirm("Voulez-vous vraiment annuler cette séance ? Cela effacera le statut validé et les récompenses associées.")) return;
                
                const dayKey = 'day' + training.selectedDay;
                const session = data.sessions[dayKey];
                
                if(session && session.undoData) {
                    // Annuler Boss
                    if(session.undoData.gainedBoss) {
                        const bName = session.undoData.bossName;
                        if(data.bossBeaten[bName] > 0) data.bossBeaten[bName]--;
                    }
                }
                
                delete data.sessions[dayKey];
                // On ne supprime pas le record, car c'est une performance historique.
                
                db.save(data);
                alert("Séance annulée.");
                training.init();
                nav.to('screen-training');
            },

            quit: () => {
                training.stopTimer();
                nav.to('screen-training');
            }
        };

        // --- TROPHY GALLERY ---
        const gallery = {
            render: () => {
                document.getElementById('trophy-char-img').src = app.getCharImage(app.getGlobalLevel());
                const recordCount = Object.keys(data.records).length; 
                document.getElementById('total-records').innerText = recordCount;

                const bossContainer = document.getElementById('boss-trophy-container');
                bossContainer.innerHTML = '';
                
                ['boss1','boss2','boss3','boss4'].forEach(bKey => {
                    if(data.bossBeaten[bKey] && data.bossBeaten[bKey] > 0) {
                         const div = document.createElement('div');
                        div.className = 'trophy-item';
                        div.innerHTML = `
                            <img src="${bKey}.png" onerror="this.src='https://via.placeholder.com/130?text=Win'">
                            <span class="trophy-count">x${data.bossBeaten[bKey]}</span>
                        `;
                        div.onclick = () => alert("Tueur de Boss (Niveau " + bKey.replace('boss','') + ")");
                        bossContainer.appendChild(div);
                    }
                });

                const furyContainer = document.getElementById('fury-container');
                furyContainer.innerHTML = '';
                if(data.furyCount > 0) {
                    furyContainer.innerHTML = `
                        <div class="trophy-item">
                            <img src="fury.png" onerror="this.src='https://via.placeholder.com/130?text=Fury'">
                            <span class="trophy-count">x${data.furyCount}</span>
                        </div>
                    `;
                } else {
                    furyContainer.innerHTML = "<div style='color:#666; font-style:italic;'>Pas encore de mode Fury activé</div>";
                }
            }
        };

        // --- NAVIGATION ---
        const nav = {
            to: (id) => {
                document.querySelectorAll('.container').forEach(d => d.classList.add('hidden'));
                document.getElementById(id).classList.remove('hidden');
                
                if(id === 'screen-menu') app.updateCharacter();
                if(id === 'screen-training') training.init();
                if(id === 'screen-trophy') gallery.render();
            }
        };

        // --- INIT ---
        document.getElementById('screen-menu').classList.remove('hidden');
        app.updateCharacter();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js');
            });
        }
    </script>
</body>
</html>
